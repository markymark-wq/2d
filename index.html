<!-- 
  2D Overlay
  cosmic-engine | 2026-02-04
  Egyszer≈± 2D k√©pk√∂vet√©s MediaPipe Hands-sel
-->
<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2D √âkszer AR - Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            overflow: hidden;
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            touch-action: none;
        }
        
        #video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 1;
        }
        
        #input_video {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* T√ºk√∂rk√©p alapb√≥l */
        }
        
        #ar-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            perspective: 1000px;
            overflow: hidden;
        }
        
        #jewelry-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: center center;
            will-change: transform;
            display: none;
            filter: drop-shadow(0 8px 16px rgba(0,0,0,0.4)) 
                    drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            transition: opacity 0.15s ease-out;
        }
        
        #jewelry-img {
            display: block;
            max-width: none;
            max-height: none;
        }
        
        #dashed-line {
            position: absolute;
            border: 2px dashed rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: none;
            pointer-events: none;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            background: rgba(255,255,255,0.1);
        }
        
        #ui-layer {
            position: fixed;
            z-index: 100;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            pointer-events: auto;
            background: rgba(0,0,0,0.6);
            padding: 15px;
            border-radius: 30px;
            backdrop-filter: blur(10px);
        }
        
        button {
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            color: #000;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        button:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.7);
        }
        
        #file-input {
            display: none;
        }
        
        .instructions {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            font-size: 18px;
            opacity: 0.8;
            pointer-events: none;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            width: 80%;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            z-index: 1000;
            display: none;
        }

        .camera-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 101;
            pointer-events: auto;
        }
        
        .mirror-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 101;
            pointer-events: auto;
        }
    </style>
</head>
<body>

    <div class="loading" id="loading">Kamera inicializ√°l√°sa...</div>

    <div id="video-container">
        <video id="input_video" playsinline></video>
    </div>

    <div id="ar-layer">
        <div id="dashed-line"></div>
        <div id="jewelry-wrapper">
            <img id="jewelry-img" src="" alt="jewelry">
        </div>
    </div>

    <div class="instructions" id="instructions">
        Tartsd a kezed a kamer√°ba<br>
        <small>Az √©kszer automatikusan megjelenik</small>
    </div>

    <div id="ui-layer">
        <button class="mirror-toggle" onclick="toggleMirror()">üîÑ T√ºk√∂r</button>
        <button class="camera-toggle" onclick="toggleCamera()">üì∑ Kamera v√°lt√°s</button>
        
        <div class="controls">
            <button onclick="document.getElementById('file-input').click()">üìø √âkszer felt√∂lt√©se</button>
            <button onclick="resetJewelry()">‚ùå T√∂rl√©s</button>
        </div>
    </div>

    <input type="file" id="file-input" accept="image/png,image/jpeg,image/webp" onchange="handleFileSelect(event)">

    <script>
        // Konfigur√°ci√≥
        const CONFIG = {
            baseJewelryWidth: 200, // Alap √©kszer sz√©less√©g pixelben
            referenceWristWidth: 60, // Referencia csukl√≥ sz√©less√©g (pixelben k√©perny≈ën)
            smoothing: 0.15, // Sim√≠t√°s faktor (0-1)
            visibilityThreshold: 0.6, // Sz√∂g k√ºsz√∂b (0-1 k√∂z√∂tt, 1=front√°lis)
            minScale: 0.3, // Minim√°lis m√©ret
            maxScale: 3.0 // Maxim√°lis m√©ret (ne takarja ki a k√©perny≈ët)
        };

        // State
        let currentCamera = 'environment'; // 'environment' = h√°tlapi, 'user' = el≈ëlapi
        let isMirrored = true;
        let jewelryImage = null;
        let isVideoReady = false;
        
        // Poz√≠ci√≥k sim√≠t√°shoz
        let currentState = {
            x: 0, y: 0,
            rotation: 0,
            scale: 1,
            visibility: 0,
            wristWidth: 50
        };

        let targetState = {
            x: 0, y: 0,
            rotation: 0,
            scale: 1,
            visibility: 0,
            wristWidth: 50
        };

        // DOM elemek
        const videoElement = document.getElementById('input_video');
        const jewelryWrapper = document.getElementById('jewelry-wrapper');
        const jewelryImg = document.getElementById('jewelry-img');
        const dashedLine = document.getElementById('dashed-line');
        const instructions = document.getElementById('instructions');
        const loading = document.getElementById('loading');

        // MediaPipe
        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onResults);

        // Kamera inicializ√°l√°s
        let camera = null;
        
        function initCamera() {
            loading.style.display = 'block';
            
            if (camera) {
                camera.stop();
            }

            camera = new Camera(videoElement, {
                onFrame: async () => {
                    await hands.send({image: videoElement});
                },
                width: 1280,
                height: 720,
                facingMode: currentCamera
            });
            
            camera.start()
                .then(() => {
                    loading.style.display = 'none';
                    isVideoReady = true;
                    // Be√°ll√≠tjuk a t√ºkr√∂z√©st CSS-ben
                    updateMirror();
                })
                .catch(err => {
                    console.error('Kamera hiba:', err);
                    loading.textContent = 'Kamera hozz√°f√©r√©s megtagadva';
                });
        }

        // T√ºk√∂r √©s kamera v√°lt√°s
        function toggleMirror() {
            isMirrored = !isMirrored;
            updateMirror();
        }

        function toggleCamera() {
            currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
            initCamera();
        }

        function updateMirror() {
            if (isMirrored) {
                videoElement.style.transform = 'scaleX(-1)';
            } else {
                videoElement.style.transform = 'scaleX(1)';
            }
        }

        // F√°jl felt√∂lt√©s
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    jewelryImg.src = e.target.result;
                    jewelryImg.onload = () => {
                        jewelryImage = true;
                        instructions.style.display = 'none';
                        jewelryWrapper.style.display = 'block';
                        // Alap m√©ret be√°ll√≠t√°sa
                        CONFIG.baseJewelryWidth = jewelryImg.naturalWidth * 0.3; // 30%-√°t haszn√°ljuk alapnak
                    };
                };
                reader.readAsDataURL(file);
            }
        }

        function resetJewelry() {
            jewelryImage = null;
            jewelryImg.src = '';
            jewelryWrapper.style.display = 'none';
            instructions.style.display = 'block';
        }

        // Matematikai seg√©df√ºggv√©nyek
        function distance(p1, p2) {
            return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
        }

        function angle(p1, p2) {
            return Math.atan2(p2.y - p1.y, p2.x - p1.x);
        }

        function lerp(start, end, factor) {
            return start + (end - start) * factor;
        }

        // F≈ë feldolgoz√≥ f√ºggv√©ny
        function onResults(results) {
            if (!jewelryImage || !isVideoReady) return;

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                
                // Landmark indexek:
                // 0: csukl√≥ (wrist)
                // 5: mutat√≥ujj alap (index finger MCP)
                // 9: k√∂z√©ps≈ë ujj alap (middle finger MCP)  
                // 13: gy≈±r≈±sujj alap (ring finger MCP)
                // 17: kisujj alap (pinky MCP)
                
                const wrist = landmarks[0];
                const index = landmarks[5];
                const middle = landmarks[9];
                const pinky = landmarks[17];
                
                // CSUKL√ì SZ√âLESS√âG becsl√©se (teny√©r sz√©less√©ge a csukl√≥n√°l)
                // A mutat√≥ujj √©s kisujj t√°vols√°ga a teny√©r sz√©less√©g√©t adja, ami k√∂zel√≠t≈ëleg 2x a csukl√≥ sz√©less√©ge
                const palmWidth = distance(index, pinky);
                const wristWidth = palmWidth * 0.6; // Csukl√≥ sz√©less√©ge ~60% a teny√©r sz√©less√©g√©n√©l
                
                // POZ√çCI√ì: A csukl√≥ √©s k√∂z√©ps≈ë ujj k√∂z√∂tt (ahol a kark√∂t≈ë √ºlne)
                // T√ºk√∂r√∂z√©s kezel√©se: ha t√ºk√∂rk√©p, az x koordin√°t√°t invert√°lni kell
                let wristX = (wrist.x + middle.x) / 2;
                let wristY = (wrist.y + middle.y) / 2;
                
                if (isMirrored) {
                    wristX = 1 - wristX;
                }
                
                // Konvert√°l√°s pixel koordin√°t√°kra
                const videoWidth = videoElement.videoWidth || window.innerWidth;
                const videoHeight = videoElement.videoHeight || window.innerHeight;
                
                const pixelX = wristX * window.innerWidth;
                const pixelY = wristY * window.innerHeight;
                
                // FORGAT√ÅS: A k√©z hossztengelye (csukl√≥ -> k√∂z√©ps≈ë ujj)
                let handAngle = angle(wrist, middle);
                if (isMirrored) {
                    handAngle = -handAngle; // T√ºk√∂rn√©l invert√°lni kell a sz√∂get
                }
                // F√ºgg≈ëleges igaz√≠t√°s (a k√©p f√ºgg≈ëleges legyen a k√©zhez k√©pest)
                const rotation = handAngle * (180 / Math.PI) + 90;
                
                // FRONTALIT√ÅS sz√°m√≠t√°sa (mennyire n√©z szembe a k√©z)
                // Ha a teny√©r sz√©less√©ge nagy -> szemben van
                // Ha a teny√©r keskeny -> oldalra fordult
                // A teny√©r hossza vs sz√©less√©ge ar√°nya adja meg
                const handLength = distance(wrist, middle);
                const aspectRatio = palmWidth / handLength;
                
                // Frontalit√°s: 1 = t√∂k√©letesen szemben, 0 = teljesen oldalt
                // Egy teny√©r √°ltal√°ban 0.8-1.0 ar√°ny√∫ szemb≈ël, oldalr√≥l 0.3-0.4
                let frontal = (aspectRatio - 0.4) / 0.6;
                frontal = Math.max(0, Math.min(1, frontal)); // Clamp 0-1
                
                // M√âRETAZ√ÅS (sk√°l√°z√°s)
                // A csukl√≥ sz√©less√©g√©hez igaz√≠tjuk az √©kszer m√©ret√©t
                // C√©l: Az √©kszer sz√©less√©ge megk√∂zel√≠t≈ëleg egyezzen a csukl√≥ sz√©less√©g√©vel (k√∂r√ºlbel√ºl)
                // De mivel egy kark√∂t≈ë k√©p √°ltal√°ban a teljes hossz√°t mutatja (k√∂r√ºlbel√ºl 3x a csukl√≥ sz√©less√©ge),
                // sk√°l√°zzuk √∫gy, hogy az illeszkedjen
                
                const scale = Math.max(CONFIG.minScale, 
                                     Math.min(CONFIG.maxScale, 
                                              (wristWidth * window.innerWidth) / CONFIG.baseJewelryWidth));
                
                // C√©lpontok be√°ll√≠t√°sa
                targetState.x = pixelX;
                targetState.y = pixelY;
                targetState.rotation = rotation;
                targetState.scale = scale;
                targetState.visibility = frontal;
                targetState.wristWidth = wristWidth * window.innerWidth; // Pixelben
                
            } else {
                // Nincs k√©z a k√©pen
                targetState.visibility = 0;
            }
        }

        // Anim√°ci√≥s loop (sim√≠t√°s)
        function animate() {
            // Sim√≠tott √©rt√©kek sz√°m√≠t√°sa
            currentState.x = lerp(currentState.x, targetState.x, CONFIG.smoothing);
            currentState.y = lerp(currentState.y, targetState.y, CONFIG.smoothing);
            currentState.rotation = lerp(currentState.rotation, targetState.rotation, CONFIG.smoothing);
            currentState.scale = lerp(currentState.scale, targetState.scale, CONFIG.smoothing);
            currentState.visibility = lerp(currentState.visibility, targetState.visibility, CONFIG.smoothing);
            currentState.wristWidth = lerp(currentState.wristWidth, targetState.wristWidth, CONFIG.smoothing);
            
            // Megjelen√≠t√©s kezel√©se
            if (currentState.visibility < 0.3) {
                // Szaggatott vonal megjelen√≠t√©se (ha van k√©z, de oldalra fordult)
                if (targetState.visibility > 0) {
                    dashedLine.style.display = 'block';
                    dashedLine.style.left = currentState.x + 'px';
                    dashedLine.style.top = currentState.y + 'px';
                    dashedLine.style.width = (currentState.wristWidth * 1.2) + 'px';
                    dashedLine.style.height = (currentState.wristWidth * 1.2) + 'px';
                    dashedLine.style.opacity = (0.3 - currentState.visibility) * 3; // Fokozatos megjelen√©s
                } else {
                    dashedLine.style.display = 'none';
                }
                
                jewelryWrapper.style.opacity = '0';
            } else {
                // √âkszer megjelen√≠t√©se
                dashedLine.style.display = 'none';
                jewelryWrapper.style.opacity = '1';
                
                // CSS 3D Transzform√°ci√≥
                // rotateX: Kicsit megd√∂ntj√ºk, hogy "r√°√ºl" a csukl√≥ra (perspekt√≠va)
                const tiltX = (1 - currentState.visibility) * 20; // Max 20 fok d√∂nt√©s ha oldalra fordul
                
                const transform = `
                    translate3d(${currentState.x}px, ${currentState.y}px, 0) 
                    rotateZ(${currentState.rotation}deg) 
                    rotateX(${tiltX}deg)
                    scale(${currentState.scale})
                `;
                
                jewelryWrapper.style.transform = transform;
            }
            
            requestAnimationFrame(animate);
        }

        // Ind√≠t√°s
        initCamera();
        animate();

    </script>
</body>
</html>

