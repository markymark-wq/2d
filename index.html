<!-- 
  2D Overlay
  cosmic-engine | 2026-02-04
  Egyszer≈± 2D k√©pk√∂vet√©s MediaPipe Hands-sel
-->
<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2D VTO - Ultimate V2</title>
    <!-- MediaPipe Hands -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            overflow: hidden;
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            touch-action: none;
        }

        /* --- VIDEO LAYER --- */
        #video-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 1;
        }
        #input_video {
            position: absolute; width: 100%; height: 100%;
            object-fit: cover; /* Kit√∂lti a k√©perny≈ët, de tartja az ar√°nyt */
            transform: scaleX(-1); /* T√ºk√∂rk√©p alapb√≥l */
        }

        /* --- 3D SCENE LAYER --- */
        #scene-3d {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            /* A m√©lys√©g kulcsa */
            perspective: 1500px;
            overflow: visible; /* A shadow ne v√°g√≥djon le */
        }

        /* Az √©kszer horgonypontja (k√∂veti a k√©z poz√≠ci√≥j√°t) */
        #wrist-anchor {
            position: absolute; top: 0; left: 0; width: 0; height: 0;
            transform-style: preserve-3d;
            will-change: transform;
        }

        /* Maga az √©kszer k√°rtya (d≈ël, fordul) */
        #jewelry-card {
            position: absolute;
            transform-style: preserve-3d;
            backface-visibility: hidden; /* Ha h√°trafordul, ne l√°tsz√≥djon */
            /* Perfect Corp szint≈± finom drop shadow */
            filter: drop-shadow(0 8px 16px rgba(0,0,0,0.25));
            /* Z-offset hogy √©rintse a b≈ërt, ne lebegjen */
            transform: translateZ(-10px);
        }

        #jewelry-img {
            display: block; max-width: none; max-height: none;
            transform: translate(-50%, -50%); /* K√∂z√©pre igaz√≠t√°s */
        }

        /* --- DASHED ARC (H√ÅTS√ì √çV) --- */
        #dashed-arc {
            position: absolute;
            border-radius: 50%;
            /* Szaggatott vonal st√≠lus - vastagabb, l√°tv√°nyosabb */
            border: 3px dashed rgba(255, 255, 255, 0.85);
            /* H√°trak√ºld√©s a k√©z m√∂g√© */
            transform: translate(-50%, -50%) translateZ(-80px);
            pointer-events: none;
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
            opacity: 0; /* Alapb√≥l rejtve, csak 30 fok ut√°n jelenik meg */
            /* Fut√≥ vonal anim√°ci√≥ */
            background: transparent;
        }

        /* Szaggatott √≠v anim√°ci√≥ - fut√≥ vonal effekt */
        @keyframes dash-rotate {
            0% { transform: translate(-50%, -50%) rotate(0deg) translateZ(-80px); }
            100% { transform: translate(-50%, -50%) rotate(360deg) translateZ(-80px); }
        }

        #dashed-arc.animating {
            animation: dash-rotate 8s linear infinite;
        }

        /* --- UI LAYER --- */
        #ui-layer {
            position: fixed; z-index: 100; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
        }

        /* Utas√≠t√°sok (Contextual Help) */
        #instruction-text {
            position: absolute; top: 20%; left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            color: white; padding: 12px 24px; border-radius: 20px;
            font-size: 14px; text-align: center;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
            pointer-events: none;
            transition: all 0.3s;
        }

        /* Vez√©rl≈ë Gombok */
        .btn {
            pointer-events: auto;
            backdrop-filter: blur(10px);
            background: rgba(0,0,0,0.7);
            color: white; border: 1px solid rgba(255,255,255,0.3);
            font-weight: 600; cursor: pointer; transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }

        /* Fels≈ë gombok */
        .top-controls {
            position: absolute; top: 20px; left: 0; width: 100%;
            display: flex; justify-content: space-between; padding: 0 20px;
        }
        .icon-btn { padding: 10px 16px; border-radius: 20px; font-size: 13px; }

        /* Als√≥ vez√©rl≈ëk */
        .main-controls {
            position: absolute; bottom: 30px; left: 50%;
            transform: translateX(-50%);
            width: 90%; max-width: 400px;
            display: flex; flex-direction: column; gap: 12px;
            pointer-events: auto;
        }

        /* M√≥d v√°laszt√≥ */
        .mode-selector {
            display: flex; gap: 10px;
            background: rgba(0,0,0,0.7); padding: 8px; border-radius: 25px;
        }
        .mode-btn {
            flex: 1; background: transparent; color: rgba(255,255,255,0.6);
            border: none; padding: 12px; border-radius: 18px; font-size: 14px;
            cursor: pointer; transition: all 0.3s;
        }
        .mode-btn.active {
            background: rgba(255,255,255,0.95); color: #000; font-weight: 700;
        }

        /* Ujj v√°laszt√≥ */
        .finger-controls {
            display: none; gap: 10px;
            background: rgba(0,0,0,0.7); padding: 10px; border-radius: 25px;
            align-items: center; justify-content: center;
        }
        .finger-controls.visible { display: flex; }
        .finger-btn {
            background: rgba(255,255,255,0.2); color: white;
            border: none; width: 40px; height: 40px; border-radius: 50%;
            font-size: 18px; cursor: pointer;
        }
        .finger-label {
            color: white; font-size: 14px; font-weight: 600;
            min-width: 100px; text-align: center;
        }

        .loading {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); color: white; z-index: 1000;
            background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;
        }
    </style>
</head>
<body>

    <div class="loading" id="loading">Kamera √©s Assetek bet√∂lt√©se...</div>

    <!-- 1. Kamera -->
    <div id="video-container">
        <video id="input_video" playsinline></video>
    </div>

    <!-- 2. 3D R√©teg -->
    <div id="scene-3d">
        <div id="wrist-anchor">
            <div id="jewelry-card">
                <img id="jewelry-img" src="" alt="jewelry" style="display:none;">
            </div>
            <!-- A szaggatott √≠v k√∂z√©ppontja megegyezik az √©kszer k√∂z√©ppontj√°val -->
            <div id="dashed-arc"></div>
        </div>
    </div>

    <!-- 3. UI -->
    <div id="ui-layer">
        <!-- Fels≈ë -->
        <div class="top-controls">
            <button class="btn icon-btn" onclick="toggleMirror()">üîÑ T√ºk√∂r</button>
            <button class="btn icon-btn" onclick="toggleCamera()">üì∑ Kamera</button>
        </div>

        <!-- Seg√©d sz√∂veg -->
        <div id="instruction-text">V√°lassz √©kszer t√≠pust</div>
        
        <!-- Lent -->
        <div class="main-controls">
            <div class="mode-selector">
                <button class="mode-btn active" id="btn-bracelet" onclick="setMode('bracelet')">üìø Kark√∂t≈ë</button>
                <button class="mode-btn" id="btn-ring" onclick="setMode('ring')">üíç Gy≈±r≈±</button>
            </div>
            
            <div class="finger-controls" id="finger-controls">
                <button class="finger-btn" onclick="prevFinger()">‚óÄ</button>
                <div class="finger-label" id="finger-label">Gy≈±r≈±sujj</div>
                <button class="finger-btn" onclick="nextFinger()">‚ñ∂</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const CONFIG = {
            assetsPath: './assets/',
            smoothing: 0.12,
            transitionStart: 30, // Fok: front√°lis v√©ge
            transitionEnd: 45,   // Fok: arc kezdete
            baseScaleBracelet: 2.2,  // Finomhangolva a csukl√≥ vastags√°g√°hoz
            baseScaleRing: 1.2,
            defaultHandSizePx: 200, // Referencia k√©zm√©ret (pixelben) a sk√°l√°z√°shoz
            maxSkewAngle: 18        // Maximum skew/d≈ël√©ssz√∂g fokban (billboard light)
        };

        // --- STATE ---
        let currentMode = 'bracelet';
        let currentFingerIndex = 2;
        const fingerNames = ['Mutat√≥ujj', 'K√∂z√©ps≈ëujj', 'Gy≈±r≈±sujj', 'Kisujj'];
        const fingerLandmarks = [
            { tip: 8, base: 5, mcp: 5, pip: 6 }, // Mutat√≥
            { tip: 12, base: 9, mcp: 9, pip: 10 }, // K√∂z√©p
            { tip: 16, base: 13, mcp: 13, pip: 14 }, // Gy≈±r≈±s
            { tip: 20, base: 17, mcp: 17, pip: 18 }  // Kisujj
        ];
        
        let currentCamera = 'environment';
        let isMirrored = true;
        let isVideoReady = false;
        
        // Anim√°ci√≥s state
        let state = {
            x: window.innerWidth/2, y: window.innerHeight/2,
            rotX: 0, rotY: 0, rotZ: 0,
            scale: 1,
            arcOpacity: 0,
            skewY: 0  // √öj: skew a d≈ël√©ssz√∂gh√∂z
        };
        let target = {
            x: window.innerWidth/2, y: window.innerHeight/2,
            rotX: 0, rotY: 0, rotZ: 0,
            scale: 1,
            arcOpacity: 0,
            skewY: 0
        };

        // --- DOM ---
        const videoElement = document.getElementById('input_video');
        const wristAnchor = document.getElementById('wrist-anchor');
        const jewelryCard = document.getElementById('jewelry-card');
        const jewelryImg = document.getElementById('jewelry-img');
        const dashedArc = document.getElementById('dashed-arc');
        const instructions = document.getElementById('instruction-text');
        const fingerControls = document.getElementById('finger-controls');
        const fingerLabel = document.getElementById('finger-label');
        const btnBracelet = document.getElementById('btn-bracelet');
        const btnRing = document.getElementById('btn-ring');

        // --- ASSET LOADER ---
        function loadAsset(type) {
            const img = new Image();
            const src = type === 'bracelet' ? CONFIG.assetsPath + 'bracelet.png' : CONFIG.assetsPath + 'ring.png';
            
            img.onload = () => {
                jewelryImg.src = src;
                jewelryImg.style.display = 'block';
                // K√©p ar√°nyainak be√°ll√≠t√°sa
                const aspect = img.naturalHeight / img.naturalWidth;
                // Kark√∂t≈ën√©l keskenyebb, hosszabb k√©pet v√°runk (√≠velt)
                const baseW = type === 'bracelet' ? 280 : 100;
                jewelryImg.style.width = baseW + 'px';
                jewelryImg.style.height = (baseW * aspect) + 'px';
            };
            img.onerror = () => {
                console.warn("Asset nem tal√°lhat√≥: " + src);
                instructions.textContent = "Hiba: '" + src + "' f√°jl nem tal√°lhat√≥!";
            };
            img.src = src;
        }

        // --- MEDIPIPE SETUP ---
        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.6,
            minTrackingConfidence: 0.6
        });

        hands.onResults(onResults);

        // --- INIT ---
        function initCamera() {
            document.getElementById('loading').style.display = 'block';
            if (window.camera) window.camera.stop();

            window.camera = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); },
                width: 1280, height: 720,
                facingMode: currentCamera
            });
            
            window.camera.start()
                .then(() => {
                    document.getElementById('loading').style.display = 'none';
                    isVideoReady = true;
                    updateMirror();
                    loadAsset(currentMode); // Automatikus bet√∂lt√©s
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('loading').textContent = "Kamera hiba!";
                });
        }

        function toggleMirror() { isMirrored = !isMirrored; updateMirror(); }
        function toggleCamera() { currentCamera = currentCamera === 'environment' ? 'user' : 'environment'; initCamera(); }
        function updateMirror() { videoElement.style.transform = isMirrored ? 'scaleX(-1)' : 'scaleX(1)'; }

        // --- UI LOGIC ---
        function setMode(mode) {
            currentMode = mode;
            loadAsset(mode); // √öj k√©p bet√∂lt√©se
            if (mode === 'bracelet') {
                btnBracelet.classList.add('active');
                btnRing.classList.remove('active');
                fingerControls.classList.remove('visible');
                instructions.textContent = "Tartsd a tenyered nyitva, a csukl√≥dat a kamera fel√©.";
            } else {
                btnBracelet.classList.remove('active');
                btnRing.classList.add('active');
                fingerControls.classList.add('visible');
                updateFingerLabel();
            }
        }

        function nextFinger() { currentFingerIndex = (currentFingerIndex + 1) % 4; updateFingerLabel(); }
        function prevFinger() { currentFingerIndex = (currentFingerIndex - 1 + 4) % 4; updateFingerLabel(); }
        function updateFingerLabel() { 
            fingerLabel.textContent = fingerNames[currentFingerIndex];
            instructions.textContent = "H√∫zd h√°tra a t√∂bbi ujjat, a " + fingerNames[currentFingerIndex].toLowerCase() + "-t ny√∫jtsd ki.";
        }

        // --- MATH HELPERS ---
        function lerp(start, end, factor) { return start + (end - start) * factor; }
        function clamp(val, min, max) { return Math.min(Math.max(val, min), max); }
        function dist(p1, p2) { return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2)); }
        function angle(p1, p2) { return Math.atan2(p2.y - p1.y, p2.x - p1.x); }

        // --- MAIN PROCESSOR ---
        function onResults(results) {
            if (!isVideoReady) return;
            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                target.arcOpacity = 0;
                target.skewY = 0;
                return;
            }

            const lm = results.multiHandLandmarks[0];
            
            // VIDE√ì RECT lek√©r√©se (A fix koordin√°t√°k kulcsa!)
            const vRect = videoElement.getBoundingClientRect();
            // Mivel a vide√≥ "cover" m√≥dban van, egy kicsit korrig√°lnunk kell a sk√°l√°t a vide√≥ ar√°nya alapj√°n,
            // de a MediaPipe a forr√°s vide√≥ ar√°nyait (16:9) adja vissza.
            // A legegyszer≈±bb: sk√°l√°zunk √∫gy, hogy a vide√≥ tartalma a k√©perny≈ëre essen.
            // A videoElement width/height a DOM m√©ret (pl. 400x900), de a bels≈ë felbont√°s 1280x720.
            const scaleX = vRect.width; // A MediaPipe 0-1 k√∂z√∂tti √©rt√©keit ezzel kell szorozni
            const scaleY = vRect.height;

            let cx, cy, rotZ, yawDeg, scale, arcSize;

            if (currentMode === 'bracelet') {
                // --- KARK√ñT≈ê ---
                const wrist = lm[0];
                const midBase = lm[9];
                const indexBase = lm[5];
                const pinkyBase = lm[17];

                // 1. Poz√≠ci√≥ - pontosan a csukl√≥ k√∂z√©ppontj√°ban
                let rawX = (wrist.x + midBase.x) / 2;
                let rawY = (wrist.y + midBase.y) / 2;
                
                cx = isMirrored ? (1 - rawX) * scaleX : rawX * scaleX;
                cy = rawY * scaleY;

                // 2. Forgat√°s (Roll)
                let dx = midBase.x - wrist.x;
                let dy = midBase.y - wrist.y;
                let ang = Math.atan2(dy, dx) * (180 / Math.PI) + 90;
                rotZ = isMirrored ? -ang : ang;

                // 3. Yaw (Oldalra fordul√°s)
                const handW = dist(lm[5], lm[17]);
                const handH = dist(lm[0], lm[9]);
                const aspect = handW / handH; // 1.0 front, 0.3 oldalt
                
                const yawFactor = clamp((aspect - 0.3) / 0.7, 0, 1);
                yawDeg = (1 - yawFactor) * 90; // 0 -> 90
                if (isMirrored) yawDeg = -yawDeg;
                if (lm[5].x > lm[17].x) yawDeg = -yawDeg; // Ir√°ny jav√≠t√°s

                // 4. Sk√°la (Dinamikus)
                // A k√©z magass√°ga alapj√°n becs√ºlj√ºk a t√°vols√°got
                const currentHandSizePx = handH * scaleX; 
                scale = (currentHandSizePx / CONFIG.defaultHandSizePx) * CONFIG.baseScaleBracelet;

                arcSize = handW * scaleX * 2.5; // A k√∂r m√©rete a teny√©r sz√©less√©g√©hez k√∂t√∂tt

            } else {
                // --- GY≈∞R≈∞ ---
                const f = fingerLandmarks[currentFingerIndex];
                const tip = lm[f.tip];
                const mcp = lm[f.mcp];
                const pip = lm[f.pip];

                // 1. Poz√≠ci√≥ (A gy≈±r≈± az MCP √©s PIP k√∂z√∂tt √ºl)
                let rawX = (mcp.x + pip.x) / 2;
                let rawY = (mcp.y + pip.y) / 2;
                
                cx = isMirrored ? (1 - rawX) * scaleX : rawX * scaleX;
                cy = rawY * scaleY;

                // 2. Forgat√°s (Roll)
                let dx = tip.x - mcp.x;
                let dy = tip.y - mcp.y;
                let ang = Math.atan2(dy, dx) * (180 / Math.PI) + 90;
                rotZ = isMirrored ? -ang : ang;

                // 3. Yaw (Ujj oldalra fordul√°sa)
                // Egyszer≈±s√≠tve: a szomsz√©d ujj t√°vols√°g√°b√≥l
                const neighborIdx = currentFingerIndex < 3 ? currentFingerIndex + 1 : 2;
                const neighbor = fingerLandmarks[neighborIdx];
                const fingerW = dist(mcp, lm[neighbor.mcp]);
                const fingerH = dist(mcp, tip);
                const aspect = fingerW / fingerH;
                
                const yawFactor = clamp((aspect - 0.3) / 0.5, 0, 1);
                yawDeg = (1 - yawFactor) * 60; // Gy≈±r≈±n√©l kisebb a tartom√°ny
                if (isMirrored) yawDeg = -yawDeg;

                // 4. Sk√°la
                const currentFingerSizePx = fingerH * scaleX;
                scale = (currentFingerSizePx / CONFIG.defaultHandSizePx) * CONFIG.baseScaleRing * 3; // Szorz√≥ finomhangol√°s

                arcSize = fingerW * scaleX * 2.0;
            }

            target.x = cx;
            target.y = cy;
            target.rotZ = rotZ;
            target.rotY = yawDeg;
            target.rotX = 0; // Pitchet most egyszer≈±s√≠tj√ºk a stabilit√°s√©rt
            target.scale = clamp(scale, 0.5, 4.0);

            // 5. √Åtmeneti Logika (30-45 fok) - Billboard Light Skew
            const absYaw = Math.abs(yawDeg);
            let arcOp = 0;
            let skewAngle = 0;
            
            if (absYaw < CONFIG.transitionStart) {
                // 0-30¬∞: csak kark√∂t≈ë, nincs skew
                arcOp = 0;
                skewAngle = 0;
            } else if (absYaw > CONFIG.transitionEnd) {
                // 45¬∞+: csak √≠v, maximum skew
                arcOp = 1;
                skewAngle = CONFIG.maxSkewAngle;
            } else {
                // 30-45¬∞ k√∂z√∂tt: smooth √°tmenet
                const t = (absYaw - CONFIG.transitionStart) / (CONFIG.transitionEnd - CONFIG.transitionStart);
                arcOp = t;
                // Skew n√∂vekszik 0-r√≥l maxSkewAngle-ra
                skewAngle = t * CONFIG.maxSkewAngle;
            }
            
            // Skew ir√°nya a yaw ir√°ny√°t√≥l f√ºgg
            target.skewY = (yawDeg > 0 ? 1 : -1) * skewAngle;
            target.arcOpacity = arcOp;
        }

        // --- RENDER LOOP ---
        function animate() {
            // Lerp sim√≠t√°s
            state.x = lerp(state.x, target.x, CONFIG.smoothing);
            state.y = lerp(state.y, target.y, CONFIG.smoothing);
            state.rotZ = lerp(state.rotZ, target.rotZ, CONFIG.smoothing);
            state.rotY = lerp(state.rotY, target.rotY, CONFIG.smoothing);
            state.rotX = lerp(state.rotX, target.rotX, CONFIG.smoothing);
            state.scale = lerp(state.scale, target.scale, CONFIG.smoothing);
            state.arcOpacity = lerp(state.arcOpacity, target.arcOpacity, 0.2);
            state.skewY = lerp(state.skewY, target.skewY, CONFIG.smoothing);

            // Anchor poz√≠ci√≥
            wristAnchor.style.transform = `translate3d(${state.x}px, ${state.y}px, 0)`;

            // √âkszer Transzform√°ci√≥ - Billboard Light effekt skewY-val
            // Ha az √≠v er≈ës (arcOpacity k√∂zel 1), az √©kszernek el kell t≈±nnie
            const jewelryVis = 1 - state.arcOpacity;
            jewelryCard.style.opacity = jewelryVis;
            
            // Az √©kszer forgat√≥dik √©s skew-ol√≥dik a k√©z 3D poz√≠ci√≥ja szerint
            jewelryCard.style.transform = `
                translateZ(-10px)
                rotateY(${state.rotY}deg) 
                rotateX(${-state.rotX}deg) 
                rotateZ(${state.rotZ}deg) 
                skewY(${state.skewY}deg)
                scale(${state.scale})
            `;

            // Dashed Arc (H√°ts√≥ √çv) Transzform√°ci√≥
            dashedArc.style.opacity = state.arcOpacity;
            dashedArc.style.width = state.arcSize + 'px';
            dashedArc.style.height = state.arcSize + 'px';
            
            // Az √≠vet is ugyan√∫gy forgatjuk, mint a kezet (rotateY)
            // translateZ(-80px) a "h√°tra" hat√°shoz - a k√©z elfedi
            dashedArc.style.transform = `
                translate(-50%, -50%) 
                rotateY(${state.rotY}deg) 
                rotateX(${-state.rotX}deg) 
                translateZ(-80px)
            `;
            
            // Anim√°ci√≥ oszt√°ly kezel√©se - csak amikor az √≠v l√°tszik
            if (state.arcOpacity > 0.1) {
                dashedArc.classList.add('animating');
            } else {
                dashedArc.classList.remove('animating');
            }

            requestAnimationFrame(animate);
        }

        // Start
        initCamera();
        setMode('bracelet'); // Alapb√≥l kark√∂t≈ë
        animate();
    </script>
</body>
</html>

