<!-- 
  CosmicAR - 2D Bracelet VTO
  Perfect Corp style - Mobile First
-->
<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CosmicAR - 2D VTO</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Telefon m√≥d k√©nyszer√≠t√©se desktopon is */
        #app-container {
            width: 100%;
            height: 100%;
            max-width: 480px; /* Max telefon sz√©less√©g */
            margin: 0 auto;
            position: relative;
            background: #000;
            overflow: hidden;
        }

        /* Desktopon centerel√©s √©s lekerek√≠t√©s */
        @media (min-width: 481px) {
            body {
                background: #1a1a1a;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            #app-container {
                height: 90vh;
                aspect-ratio: 9/16;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            }
        }

        /* --- VIDEO LAYER --- */
        #video-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
        }
        
        #input_video {
            width: 100%; height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* T√ºk√∂rk√©p */
        }

        /* --- AR LAYER --- */
        #ar-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10;
            pointer-events: none;
            /* 3D t√©r a perspective-hez */
            perspective: 1000px;
        }

        /* Csukl√≥ anchor - EZ MOZOG a k√©z szerint */
        #wrist-anchor {
            position: absolute;
            /* KEZD≈ê POZ√çCI√ì - k√∂z√©pen */
            left: 50%; top: 50%;
            width: 0; height: 0;
            transform-style: preserve-3d;
            will-change: transform;
        }

        /* KARK√ñT≈ê K√âP */
        #jewelry-wrapper {
            position: absolute;
            left: 0; top: 0;
            transform-style: preserve-3d;
            /* Z-offset hogy ne lebegjen, hanem "√©rintse" a b≈ërt */
            transform: translateZ(-5px);
        }

        #jewelry-img {
            display: block;
            /* K√∂z√©pre igaz√≠t√°s a wrapperen bel√ºl */
            transform: translate(-50%, -50%);
            /* Perfect Corp style √°rny√©k */
            filter: drop-shadow(0 6px 12px rgba(0,0,0,0.3));
            max-width: none;
            max-height: none;
        }

        /* DASHED ARC - A CSUKL√ì K√ñR√úL */
        #dashed-arc {
            position: absolute;
            left: 0; top: 0;
            width: 200px; height: 200px;
            margin-left: -100px; margin-top: -100px; /* K√∂z√©pre igaz√≠t√°s */
            border-radius: 50%;
            border: 3px dashed rgba(255, 255, 255, 0.9);
            /* H√°tr√©bb tolva Z-ben - a k√©z elfedi */
            transform: translateZ(-100px);
            opacity: 0;
            pointer-events: none;
            /* Fut√≥ vonal anim√°ci√≥ */
            animation: dash-rotate 6s linear infinite;
        }

        @keyframes dash-rotate {
            from { transform: translateZ(-100px) rotate(0deg); }
            to { transform: translateZ(-100px) rotate(360deg); }
        }

        /* --- UI LAYER --- */
        #ui-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 100;
            pointer-events: none;
        }

        #instruction-text {
            position: absolute;
            top: 15%; left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            color: white; 
            padding: 12px 20px; 
            border-radius: 20px;
            font-size: 14px; 
            text-align: center;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.15);
            white-space: nowrap;
        }

        .btn {
            pointer-events: auto;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            color: white; 
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            font-weight: 600; 
            cursor: pointer;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }

        .top-controls {
            position: absolute; 
            top: 12px; left: 0; 
            width: 100%;
            display: flex; 
            justify-content: space-between; 
            padding: 0 16px;
        }
        
        .icon-btn { 
            padding: 8px 14px; 
            font-size: 12px; 
        }

        .bottom-controls {
            position: absolute; 
            bottom: 24px; left: 50%;
            transform: translateX(-50%);
            width: 90%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: auto;
        }

        .mode-selector {
            display: flex; 
            gap: 8px;
            background: rgba(0,0,0,0.7); 
            padding: 6px; 
            border-radius: 24px;
            backdrop-filter: blur(10px);
        }
        
        .mode-btn {
            flex: 1; 
            background: transparent; 
            color: rgba(255,255,255,0.7);
            border: none; 
            padding: 12px; 
            border-radius: 18px; 
            font-size: 14px;
            cursor: pointer; 
            transition: all 0.25s;
            font-weight: 600;
        }
        
        .mode-btn.active {
            background: rgba(255,255,255,0.95); 
            color: #000;
        }

        .finger-controls {
            display: none; 
            gap: 12px;
            background: rgba(0,0,0,0.7); 
            padding: 8px 16px; 
            border-radius: 24px;
            align-items: center; 
            justify-content: center;
            backdrop-filter: blur(10px);
        }
        
        .finger-controls.visible { display: flex; }
        
        .finger-btn {
            background: rgba(255,255,255,0.2); 
            color: white;
            border: none; 
            width: 36px; height: 36px; 
            border-radius: 50%;
            font-size: 16px; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .finger-label {
            color: white; 
            font-size: 14px; 
            font-weight: 600;
            min-width: 100px; 
            text-align: center;
        }

        .loading {
            position: fixed; 
            top: 50%; left: 50%;
            transform: translate(-50%, -50%); 
            color: white; 
            z-index: 1000;
            background: rgba(0,0,0,0.85); 
            padding: 24px 32px; 
            border-radius: 16px;
            font-size: 14px;
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="app-container">
        <div class="loading" id="loading">Kamera bet√∂lt√©se...</div>

        <!-- Video Layer -->
        <div id="video-layer">
            <video id="input_video" playsinline></video>
        </div>

        <!-- AR Layer -->
        <div id="ar-layer">
            <div id="wrist-anchor">
                <!-- Kark√∂t≈ë -->
                <div id="jewelry-wrapper">
                    <img id="jewelry-img" src="" alt="jewelry" style="display:none;">
                </div>
                <!-- Dashed Arc - a csukl√≥ k√∂r√ºl -->
                <div id="dashed-arc"></div>
            </div>
        </div>

        <!-- UI Layer -->
        <div id="ui-layer">
            <div class="top-controls">
                <button class="btn icon-btn" onclick="toggleMirror()">üîÑ T√ºk√∂r</button>
                <button class="btn icon-btn" onclick="toggleCamera()">üì∑ Kamera</button>
            </div>

            <div id="instruction-text">Tartsd a csukl√≥dat a kamera fel√©</div>
            
            <div class="bottom-controls">
                <div class="mode-selector">
                    <button class="mode-btn active" id="btn-bracelet" onclick="setMode('bracelet')">üìø Kark√∂t≈ë</button>
                    <button class="mode-btn" id="btn-ring" onclick="setMode('ring')">üíç Gy≈±r≈±</button>
                </div>
                
                <div class="finger-controls" id="finger-controls">
                    <button class="finger-btn" onclick="prevFinger()">‚óÄ</button>
                    <div class="finger-label" id="finger-label">Gy≈±r≈±sujj</div>
                    <button class="finger-btn" onclick="nextFinger()">‚ñ∂</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- KONFIGUR√ÅCI√ì ---
        const CONFIG = {
            assetsPath: './Assets/',
            smoothing: 0.15,       // Sim√≠t√°s (0-1)
            transitionStart: 30,   // Yaw sz√∂g amikor elkezd √°tt≈±nni
            transitionEnd: 55,     // Yaw sz√∂g amikor teljesen √°tt≈±nt
            baseScaleBracelet: 1.8,
            baseScaleRing: 1.0,
            maxRotationY: 45       // Max Y rot√°ci√≥ fokban
        };

        // --- √ÅLLAPOT ---
        let currentMode = 'bracelet';
        let currentFingerIndex = 2;
        const fingerNames = ['Mutat√≥ujj', 'K√∂z√©ps≈ëujj', 'Gy≈±r≈±sujj', 'Kisujj'];
        const fingerLandmarks = [
            { tip: 8, mcp: 5 },   // Mutat√≥
            { tip: 12, mcp: 9 },  // K√∂z√©p
            { tip: 16, mcp: 13 }, // Gy≈±r≈±s
            { tip: 20, mcp: 17 }  // Kisujj
        ];
        
        let currentCamera = 'environment';
        let isMirrored = true;
        let isVideoReady = false;
        
        // Anim√°ci√≥s √°llapot (sim√≠tott √©rt√©kek)
        let state = {
            x: 0.5, y: 0.5,        // Normaliz√°lt poz√≠ci√≥ (0-1)
            rotation: 0,           // Z tengely k√∂r√ºli forgat√°s
            rotationY: 0,          // Y tengely k√∂r√ºli forgat√°s (oldalra fordul√°s)
            scale: 1,
            arcOpacity: 0,
            visibility: 1          // Kark√∂t≈ë l√°that√≥s√°ga
        };
        
        let target = {
            x: 0.5, y: 0.5,
            rotation: 0,
            rotationY: 0,
            scale: 1,
            arcOpacity: 0,
            visibility: 1
        };

        // --- DOM REFERENCI√ÅK ---
        const videoElement = document.getElementById('input_video');
        const wristAnchor = document.getElementById('wrist-anchor');
        const jewelryWrapper = document.getElementById('jewelry-wrapper');
        const jewelryImg = document.getElementById('jewelry-img');
        const dashedArc = document.getElementById('dashed-arc');
        const instructions = document.getElementById('instruction-text');
        const fingerControls = document.getElementById('finger-controls');
        const fingerLabel = document.getElementById('finger-label');
        const btnBracelet = document.getElementById('btn-bracelet');
        const btnRing = document.getElementById('btn-ring');
        const appContainer = document.getElementById('app-container');

        // --- ASSET BET√ñLT√âS ---
        function loadAsset(type) {
            const img = new Image();
            const src = type === 'bracelet' 
                ? CONFIG.assetsPath + 'bracelet.png' 
                : CONFIG.assetsPath + 'ring.png';
            
            img.onload = () => {
                jewelryImg.src = src;
                jewelryImg.style.display = 'block';
                
                // M√©ret be√°ll√≠t√°sa az ar√°nyok alapj√°n
                const aspect = img.naturalHeight / img.naturalWidth;
                const baseW = type === 'bracelet' ? 200 : 80;
                jewelryImg.style.width = baseW + 'px';
                jewelryImg.style.height = (baseW * aspect) + 'px';
            };
            
            img.onerror = () => {
                console.error("Asset nem tal√°lhat√≥:", src);
                instructions.textContent = "Hiba: Nem tal√°lhat√≥ a k√©p!";
            };
            
            img.src = src;
        }

        // --- MEDIPIPE BE√ÅLL√çT√ÅS ---
        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onResults);

        // --- KAMERA IND√çT√ÅS ---
        function initCamera() {
            document.getElementById('loading').style.display = 'block';
            
            if (window.camera) window.camera.stop();

            window.camera = new Camera(videoElement, {
                onFrame: async () => await hands.send({image: videoElement}),
                width: 1280, 
                height: 720,
                facingMode: currentCamera
            });
            
            window.camera.start()
                .then(() => {
                    document.getElementById('loading').style.display = 'none';
                    isVideoReady = true;
                    updateMirror();
                    loadAsset(currentMode);
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('loading').textContent = "Kamera hiba! Enged√©lyezd a kamer√°t.";
                });
        }

        function toggleMirror() { 
            isMirrored = !isMirrored; 
            updateMirror(); 
        }
        
        function toggleCamera() { 
            currentCamera = currentCamera === 'environment' ? 'user' : 'environment'; 
            initCamera(); 
        }
        
        function updateMirror() { 
            videoElement.style.transform = isMirrored ? 'scaleX(-1)' : 'scaleX(1)'; 
        }

        // --- UI LOGIKA ---
        function setMode(mode) {
            currentMode = mode;
            loadAsset(mode);
            
            if (mode === 'bracelet') {
                btnBracelet.classList.add('active');
                btnRing.classList.remove('active');
                fingerControls.classList.remove('visible');
                instructions.textContent = "Tartsd a csukl√≥dat a kamera fel√©";
            } else {
                btnBracelet.classList.remove('active');
                btnRing.classList.add('active');
                fingerControls.classList.add('visible');
                updateFingerLabel();
            }
        }

        function nextFinger() { 
            currentFingerIndex = (currentFingerIndex + 1) % 4; 
            updateFingerLabel(); 
        }
        
        function prevFinger() { 
            currentFingerIndex = (currentFingerIndex - 1 + 4) % 4; 
            updateFingerLabel(); 
        }
        
        function updateFingerLabel() { 
            fingerLabel.textContent = fingerNames[currentFingerIndex];
            instructions.textContent = "Ny√∫jtsd ki a " + fingerNames[currentFingerIndex].toLowerCase() + "-t";
        }

        // --- SEG√âDF√úGGV√âNYEK ---
        function lerp(start, end, factor) { 
            return start + (end - start) * factor; 
        }
        
        function clamp(val, min, max) { 
            return Math.min(Math.max(val, min), max); 
        }
        
        function dist(p1, p2) { 
            return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2)); 
        }

        // --- F≈ê FELDOLGOZ√ì ---
        function onResults(results) {
            if (!isVideoReady) return;
            
            // Nincs k√©z - fade out
            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                target.visibility = 0;
                target.arcOpacity = 0;
                return;
            }

            const lm = results.multiHandLandmarks[0];
            
            // Aktu√°lis k√©perny≈ë m√©ret (telefon m√≥d)
            const screenW = appContainer.offsetWidth;
            const screenH = appContainer.offsetHeight;

            let centerX, centerY, rotation, yawDeg, scale;

            if (currentMode === 'bracelet') {
                // --- KARK√ñT≈ê LOGIKA ---
                const wrist = lm[0];      // Csukl√≥
                const midBase = lm[9];    // K√∂z√©ps≈ë ujj alapja
                const indexBase = lm[5];  // Mutat√≥ alapja
                const pinkyBase = lm[17]; // Kisujj alapja

                // 1. POZ√çCI√ì: Csukl√≥ k√∂z√©ppont
                centerX = (wrist.x + midBase.x) / 2;
                centerY = (wrist.y + midBase.y) / 2;

                // 2. FORGAT√ÅS (Z tengely): A k√©z d≈ël√©se
                const dx = midBase.x - wrist.x;
                const dy = midBase.y - wrist.y;
                const angle = Math.atan2(dy, dx) * (180 / Math.PI);
                // +90 hogy v√≠zszintesen √°lljon a kark√∂t≈ë
                rotation = angle + 90;
                if (isMirrored) rotation = -rotation;

                // 3. YAW (oldalra fordul√°s): A k√©z lap√≠t√°s√°b√≥l sz√°molva
                const handWidth = dist(indexBase, pinkyBase);
                const handHeight = dist(wrist, midBase);
                const aspect = handWidth / (handHeight || 0.001);
                
                // Aspect ~1.0 = front√°lis, ~0.3 = oldalra fordult
                const yawFactor = clamp((aspect - 0.35) / 0.65, 0, 1);
                yawDeg = (1 - yawFactor) * CONFIG.maxRotationY;
                
                // Ir√°ny meghat√°roz√°sa
                if (isMirrored) yawDeg = -yawDeg;
                if (indexBase.x > pinkyBase.x) yawDeg = -yawDeg;

                // 4. SK√ÅLA: A k√©z m√©ret√©b≈ël
                const handSizePx = handHeight * screenH;
                scale = (handSizePx / 150) * CONFIG.baseScaleBracelet;

            } else {
                // --- GY≈∞R≈∞ LOGIKA ---
                const f = fingerLandmarks[currentFingerIndex];
                const tip = lm[f.tip];
                const mcp = lm[f.mcp];

                // Poz√≠ci√≥: ujj k√∂z√©ps≈ë r√©sze
                centerX = (mcp.x + tip.x) / 2;
                centerY = (mcp.y + tip.y) / 2;

                // Forgat√°s: ujj ir√°nya
                const dx = tip.x - mcp.x;
                const dy = tip.y - mcp.y;
                const angle = Math.atan2(dy, dx) * (180 / Math.PI);
                rotation = angle + 90;
                if (isMirrored) rotation = -rotation;

                // Yaw egyszer≈±s√≠tve
                yawDeg = 0;

                // Sk√°la
                const fingerLen = dist(mcp, tip) * screenH;
                scale = (fingerLen / 100) * CONFIG.baseScaleRing;
            }

            // T√ºk√∂rz√©s kezel√©se a poz√≠ci√≥n√°l
            if (isMirrored) centerX = 1 - centerX;

            // C√©l √©rt√©kek be√°ll√≠t√°sa
            target.x = centerX;
            target.y = centerY;
            target.rotation = rotation;
            target.rotationY = yawDeg;
            target.scale = clamp(scale, 0.3, 3.0);

            // √ÅTT≈∞N√âSI LOGIKA (30-55 fok k√∂z√∂tt)
            const absYaw = Math.abs(yawDeg);
            
            if (absYaw < CONFIG.transitionStart) {
                // Front√°lis - csak kark√∂t≈ë
                target.visibility = 1;
                target.arcOpacity = 0;
            } else if (absYaw > CONFIG.transitionEnd) {
                // Oldalra fordult - csak arc
                target.visibility = 0;
                target.arcOpacity = 1;
            } else {
                // √Åtmeneti z√≥na - smooth interpol√°ci√≥
                const t = (absYaw - CONFIG.transitionStart) / (CONFIG.transitionEnd - CONFIG.transitionStart);
                target.visibility = 1 - t;
                target.arcOpacity = t;
            }
        }

        // --- RENDER LOOP ---
        function animate() {
            const screenW = appContainer.offsetWidth;
            const screenH = appContainer.offsetHeight;

            // Sim√≠t√°s (Lerp)
            state.x = lerp(state.x, target.x, CONFIG.smoothing);
            state.y = lerp(state.y, target.y, CONFIG.smoothing);
            state.rotation = lerp(state.rotation, target.rotation, CONFIG.smoothing);
            state.rotationY = lerp(state.rotationY, target.rotationY, CONFIG.smoothing);
            state.scale = lerp(state.scale, target.scale, CONFIG.smoothing);
            state.arcOpacity = lerp(state.arcOpacity, target.arcOpacity, 0.1);
            state.visibility = lerp(state.visibility, target.visibility, CONFIG.smoothing);

            // Poz√≠ci√≥ √°tv√°lt√°sa pixelre
            const pixelX = state.x * screenW;
            const pixelY = state.y * screenH;

            // Anchor mozgat√°sa
            wristAnchor.style.left = pixelX + 'px';
            wristAnchor.style.top = pixelY + 'px';

            // KARK√ñT≈ê TRANSZFORM√ÅCI√ì
            // - visibility: √°tt≈±n√©s
            // - rotateY: oldalra fordul√°s 3D-ben
            // - rotateZ: k√©z d≈ël√©se
            // - scale: m√©ret
            jewelryWrapper.style.opacity = state.visibility;
            jewelryWrapper.style.transform = `
                translateZ(-5px)
                rotateY(${state.rotationY}deg)
                rotateZ(${state.rotation}deg)
                scale(${state.scale})
            `;

            // DASHED ARC
            // Ugyanaz a poz√≠ci√≥, csak h√°tr√©bb Z-ben √©s fade-elve
            const arcSize = 180 * state.scale;
            dashedArc.style.width = arcSize + 'px';
            dashedArc.style.height = arcSize + 'px';
            dashedArc.style.marginLeft = -(arcSize/2) + 'px';
            dashedArc.style.marginTop = -(arcSize/2) + 'px';
            dashedArc.style.opacity = state.arcOpacity;
            
            // Az arc is forduljon a k√©zzel
            dashedArc.style.transform = `
                translateZ(-100px)
                rotateY(${state.rotationY}deg)
                rotateZ(${state.rotation}deg)
            `;

            requestAnimationFrame(animate);
        }

        // --- IND√çT√ÅS ---
        initCamera();
        setMode('bracelet');
        animate();
    </script>
</body>
</html>
