<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CosmicAR - 2D VTO (Fixed)</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        #app-container {
            width: 100%;
            height: 100%;
            max-width: 480px;
            margin: 0 auto;
            position: relative;
            background: #000;
            overflow: hidden;
        }

        @media (min-width: 481px) {
            body {
                background: #1a1a1a;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            #app-container {
                height: 90vh;
                aspect-ratio: 9/16;
                border-radius: 24px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            }
        }

        #video-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
            object-fit: cover;
        }
        
        #input_video {
            width: 100%; height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        #ar-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10;
            pointer-events: none;
            perspective: 1200px;
        }

        /* WRIST ANCHOR - Poz√≠cion√°l√°s csukl√≥n√°l */
        #wrist-anchor {
            position: absolute;
            top: 50%; left: 50%;
            width: 0; height: 0;
            transform-style: preserve-3d;
            will-change: transform;
        }

        /* KARK√ñT≈ê - A csukl√≥ k√∂r√ºl fog √°llni 3D-ben */
        #jewelry-wrapper {
            position: absolute;
            left: 0; top: 0;
            transform-style: preserve-3d;
            /* A k√©z tengely√©re mer≈ëleges s√≠kban van, hogy k√∂r√ºl√∂lelje a csukl√≥t */
            transform: translate(-50%, -50%) rotateX(var(--hand-pitch, 0deg)) scale(var(--jewelry-scale, 1));
            opacity: var(--jewelry-opacity, 0);
            transition: opacity 0.2s;
        }

        #jewelry-img {
            display: block;
            max-width: none;
            pointer-events: none;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.4));
        }

        /* SZAGGATOTT VONAL - K√∂r√ºl√∂leli a csukl√≥t */
        #dashed-arc {
            position: absolute;
            left: 50%; top: 50%;
            width: 140px; /* Dinamikusan √°ll√≠tjuk JS-b≈ël */
            height: 140px;
            border-radius: 50%;
            border: 8px dashed rgba(255, 255, 255, 0.9);
            transform: translate(-50%, -50%) rotateX(var(--hand-pitch, -75deg)) rotateZ(var(--hand-rotation, 0deg)) scale(var(--arc-scale, 1));
            transform-style: preserve-3d;
            pointer-events: none;
            opacity: var(--arc-opacity, 0);
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
        }

        @keyframes dash-spin {
            0% { border-color: rgba(255,255,255,0.5); }
            50% { border-color: rgba(255,255,255,1); }
            100% { border-color: rgba(255,255,255,0.5); }
        }
        
        #dashed-arc.active {
            animation: dash-spin 1.5s infinite ease-in-out;
        }

        /* UI st√≠lusok v√°ltozatlanok */
        #ui-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 100;
            pointer-events: none;
        }

        #instruction-text {
            position: absolute;
            top: 15%; left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white; 
            padding: 10px 18px; 
            border-radius: 20px;
            font-size: 13px; 
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            white-space: nowrap;
        }

        .btn {
            pointer-events: auto;
            background: rgba(30,30,30,0.8);
            backdrop-filter: blur(12px);
            color: white; 
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 16px;
            font-weight: 600; 
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }
        .btn:active { transform: scale(0.95); background: rgba(50,50,50,0.9); }

        .top-controls {
            position: absolute; 
            top: 10px; left: 0; 
            width: 100%;
            display: flex; 
            justify-content: space-between; 
            padding: 0 12px;
        }
        
        .icon-btn { padding: 8px 12px; }

        .bottom-controls {
            position: absolute; 
            bottom: 20px; left: 50%;
            transform: translateX(-50%);
            width: 92%;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: auto;
        }

        .mode-selector {
            display: flex; 
            gap: 6px;
            background: rgba(30,30,30,0.85); 
            padding: 4px; 
            border-radius: 20px;
            backdrop-filter: blur(12px);
        }
        
        .mode-btn {
            flex: 1; 
            background: transparent; 
            color: rgba(255,255,255,0.6);
            border: none; 
            padding: 10px; 
            border-radius: 16px; 
            font-size: 13px;
            cursor: pointer; 
            transition: all 0.2s;
            font-weight: 600;
        }
        
        .mode-btn.active {
            background: #fff; 
            color: #000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .loading {
            position: fixed; 
            top: 50%; left: 50%;
            transform: translate(-50%, -50%); 
            color: white; 
            z-index: 1000;
            background: rgba(0,0,0,0.9); 
            padding: 20px 30px; 
            border-radius: 16px;
            font-size: 14px;
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="app-container">
        <div class="loading" id="loading">Kamera inicializ√°l√°sa...</div>

        <div id="video-layer">
            <video id="input_video" playsinline></video>
        </div>

        <div id="ar-layer">
            <!-- A csukl√≥ poz√≠cion√°l√°s√°hoz -->
            <div id="wrist-anchor" style="display:none;"></div>
            
            <!-- Szaggatott vonal - k√∂zvetlen√ºl az ar-layerben, nem anchor gyermeke -->
            <div id="dashed-arc"></div>
            
            <!-- Kark√∂t≈ë - k√∂zvetlen√ºl az ar-layerben -->
            <div id="jewelry-wrapper">
                <img id="jewelry-img" src="" alt="jewelry" style="display:none;">
            </div>
        </div>

        <div id="ui-layer">
            <div class="top-controls">
                <button class="btn icon-btn" onclick="toggleMirror()">üîÑ T√ºk√∂r</button>
                <button class="btn icon-btn" onclick="toggleCamera()">üì∑ Kamera</button>
            </div>

            <div id="instruction-text">Tartsd a csukl√≥dat a kamera fel√©</div>
            
            <div class="bottom-controls">
                <div class="mode-selector">
                    <button class="mode-btn active" id="btn-bracelet" onclick="setMode('bracelet')">üìø Kark√∂t≈ë</button>
                    <button class="mode-btn" id="btn-ring" onclick="setMode('ring')">üíç Gy≈±r≈±</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            assetsPath: './assets/',
            smoothing: 0.15,
            baseScaleBracelet: 2.2,
            worldScaleFactor: 1000
        };

        let currentMode = 'bracelet';
        let currentCamera = 'environment';
        let isMirrored = true;
        let isVideoReady = false;
        
        // √Ållapot
        let state = {
            x: 0.5, y: 0.5,
            rotationZ: 0,        // K√©z elfordul√°sa
            pitch: -75,          // K√©z d≈ël√©se (teny√©r el≈ëre/le)
            scale: 1,
            visibility: 0,
            arcOpacity: 0
        };
        
        let target = {
            x: 0.5, y: 0.5,
            rotationZ: 0,
            pitch: -75,
            scale: 1,
            visibility: 0,
            arcOpacity: 0
        };

        const videoElement = document.getElementById('input_video');
        const jewelryWrapper = document.getElementById('jewelry-wrapper');
        const jewelryImg = document.getElementById('jewelry-img');
        const dashedArc = document.getElementById('dashed-arc');
        const instructions = document.getElementById('instruction-text');
        const appContainer = document.getElementById('app-container');

        // Asset bet√∂lt√©s
        function loadAsset(mode) {
            const img = new Image();
            const src = mode === 'bracelet' 
                ? CONFIG.assetsPath + 'bracelet.png' 
                : CONFIG.assetsPath + 'ring.png';
            
            img.onload = () => {
                jewelryImg.src = src;
                jewelryImg.style.display = 'block';
                
                // M√©ret be√°ll√≠t√°sa
                const aspect = img.naturalHeight / img.naturalWidth;
                const baseW = mode === 'bracelet' ? 200 : 70;
                jewelryImg.style.width = baseW + 'px';
                jewelryImg.style.height = (baseW * aspect) + 'px';
            };
            
            img.onerror = () => {
                instructions.textContent = "Hiba: K√©p nem tal√°lhat√≥ az 'assets' mapp√°ban";
            };
            
            img.src = src;
        }

        // MediaPipe
        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onResults);

        function initCamera() {
            document.getElementById('loading').style.display = 'block';
            
            if (window.camera) {
                try { window.camera.stop(); } catch(e){}
            }

            window.camera = new Camera(videoElement, {
                onFrame: async () => await hands.send({image: videoElement}),
                width: 1280, 
                height: 720,
                facingMode: currentCamera
            });
            
            window.camera.start()
                .then(() => {
                    document.getElementById('loading').style.display = 'none';
                    isVideoReady = true;
                    updateMirror();
                    loadAsset(currentMode);
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('loading').textContent = "Kamera hiba!";
                });
        }

        function toggleMirror() { 
            isMirrored = !isMirrored; 
            updateMirror(); 
        }
        
        function toggleCamera() { 
            currentCamera = currentCamera === 'environment' ? 'user' : 'environment'; 
            initCamera(); 
        }
        
        function updateMirror() { 
            videoElement.style.transform = isMirrored ? 'scaleX(-1)' : 'scaleX(1)'; 
        }

        function setMode(mode) {
            currentMode = mode;
            loadAsset(mode);
            document.getElementById('btn-bracelet').classList.toggle('active', mode === 'bracelet');
            document.getElementById('btn-ring').classList.toggle('active', mode === 'ring');
        }

        function lerp(start, end, factor) { 
            return start + (end - start) * factor; 
        }
        
        function clamp(val, min, max) { 
            return Math.min(Math.max(val, min), max); 
        }

        // F≈ê LOGIKA
        function onResults(results) {
            if (!isVideoReady) return;
            
            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                target.visibility = 0;
                target.arcOpacity = 0;
                return;
            }

            const lm = results.multiHandLandmarks[0];
            const worldLm = results.multiHandWorldLandmarks[0];
            
            const screenW = appContainer.offsetWidth;
            const screenH = appContainer.offsetHeight;

            // 1. POZ√çCI√ì - Pontosan a csukl√≥ (landmark 0)
            let centerX = lm[0].x;
            let centerY = lm[0].y;
            
            if (isMirrored) centerX = 1 - centerX;

            target.x = centerX;
            target.y = centerY;

            // 2. K√âZ TENGELY√âNEK SZ√ñGE (Rotation Z)
            // Csukl√≥ (0) -> K√∂z√©ps≈ë ujj alapja (9)
            const dx = lm[9].x - lm[0].x;
            const dy = lm[9].y - lm[0].y;
            let angleZ = Math.atan2(dy, dx) * (180 / Math.PI);
            angleZ = angleZ + 90; // Mer≈ëleges a k√©zre
            
            if (isMirrored) angleZ = -angleZ;
            
            // Stabiliz√°l√°s
            if (angleZ - state.rotationZ > 180) angleZ -= 360;
            if (angleZ - state.rotationZ < -180) angleZ += 360;
            
            target.rotationZ = angleZ;

            // 3. K√âZ "PITCH" SZ√ñGE (Teny√©r el≈ëre vagy lefel√© n√©z?)
            // WorldLandmarks: Z koordin√°ta (m√©lys√©g)
            // Ha wrist.z < middle.z, akkor a csukl√≥ k√∂zelebb van -> teny√©r el≈ëre (f√ºgg≈ëleges)
            // Ha wrist.z > middle.z, akkor a k√∂z√©ps≈ë ujj k√∂zelebb van -> teny√©r lefel√© (v√≠zszintes)
            const wristZ = worldLm[0].z;
            const middleZ = worldLm[9].z;
            const zDiff = wristZ - middleZ;
            
            // zDiff nagyj√°b√≥l -0.05 √©s +0.05 k√∂z√∂tt v√°ltozik
            // -0.05 = teny√©r lefel√© (v√≠zszintes k√©z), pitch = -90
            // +0.05 = teny√©r el≈ëre (f√ºgg≈ëleges k√©z), pitch = 0
            
            let targetPitch = -75; // Alap√©rtelmezett (v√≠zszintes k√©z)
            
            if (zDiff > 0.02) {
                // Teny√©r el≈ëre n√©z - a vonal f√ºgg≈ëleges legyen (k√∂r√ºl√∂leli a csukl√≥t)
                targetPitch = 0;
            } else if (zDiff < -0.02) {
                // Teny√©r lefel√© n√©z - a vonal v√≠zszintes legyen
                targetPitch = -90;
            } else {
                // √Åtmenet
                targetPitch = -45;
            }
            
            target.pitch = targetPitch;

            // 4. SK√ÅLA - World landmarks t√°vols√°g alapj√°n
            const worldWristWidth = Math.sqrt(
                Math.pow(worldLm[5].x - worldLm[17].x, 2) + 
                Math.pow(worldLm[5].y - worldLm[17].y, 2) + 
                Math.pow(worldLm[5].z - worldLm[17].z, 2)
            );
            
            target.scale = clamp(worldWristWidth * CONFIG.worldScaleFactor * CONFIG.baseScaleBracelet, 0.8, 3.0);

            // 5. L√ÅTHAT√ìS√ÅG V√ÅLT√ÅS
            if (currentMode === 'bracelet') {
                if (zDiff > 0.02) {
                    // Teny√©r el≈ëre -> Szaggatott vonal l√°tszik (k√∂r√ºl√∂leli a csukl√≥t)
                    target.visibility = 0;
                    target.arcOpacity = 1;
                } else {
                    // Teny√©r lefel√© -> Kark√∂t≈ë l√°tszik
                    target.visibility = 1;
                    target.arcOpacity = 0;
                }
            } else {
                target.visibility = 1;
                target.arcOpacity = 0;
            }
        }

        // RENDER LOOP
        function animate() {
            const screenW = appContainer.offsetWidth;
            const screenH = appContainer.offsetHeight;

            // Sim√≠t√°s
            state.x = lerp(state.x, target.x, CONFIG.smoothing);
            state.y = lerp(state.y, target.y, CONFIG.smoothing);
            state.rotationZ = lerp(state.rotationZ, target.rotationZ, CONFIG.smoothing);
            state.pitch = lerp(state.pitch, target.pitch, 0.1);
            state.scale = lerp(state.scale, target.scale, CONFIG.smoothing);
            state.arcOpacity = lerp(state.arcOpacity, target.arcOpacity, 0.1);
            state.visibility = lerp(state.visibility, target.visibility, CONFIG.smoothing);

            // Pixel poz√≠ci√≥
            const pixelX = state.x * screenW;
            const pixelY = state.y * screenH;

            // CSS V√°ltoz√≥k be√°ll√≠t√°sa
            const arcSize = 140 * state.scale;
            dashedArc.style.width = arcSize + 'px';
            dashedArc.style.height = arcSize + 'px';
            dashedArc.style.left = pixelX + 'px';
            dashedArc.style.top = pixelY + 'px';
            dashedArc.style.setProperty('--hand-pitch', state.pitch + 'deg');
            dashedArc.style.setProperty('--hand-rotation', state.rotationZ + 'deg');
            dashedArc.style.setProperty('--arc-scale', state.scale);
            dashedArc.style.setProperty('--arc-opacity', state.arcOpacity);
            
            if (state.arcOpacity > 0.1) {
                dashedArc.classList.add('active');
            } else {
                dashedArc.classList.remove('active');
            }

            // Kark√∂t≈ë pozicion√°l√°s
            jewelryWrapper.style.left = pixelX + 'px';
            jewelryWrapper.style.top = pixelY + 'px';
            jewelryWrapper.style.setProperty('--hand-pitch', state.pitch + 'deg');
            jewelryWrapper.style.setProperty('--jewelry-scale', state.scale);
            jewelryWrapper.style.setProperty('--jewelry-opacity', state.visibility);

            requestAnimationFrame(animate);
        }

        // Init
        initCamera();
        setMode('bracelet');
        animate();
    </script>
</body>
</html>
