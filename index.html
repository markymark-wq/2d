<!-- 
  2D Overlay
  cosmic-engine | 2026-02-04
  Egyszer≈± 2D k√©pk√∂vet√©s MediaPipe Hands-sel
-->
<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2D AR √âkszer VTO</title>
    <!-- MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            overflow: hidden;
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            touch-action: none;
        }
        
        /* Kamera teljes k√©perny≈ën */
        #input_video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            transform: scaleX(-1); /* T√ºk√∂rk√©p */
            z-index: 1;
        }
        
        /* √âkszer kont√©ner - 3D perspekt√≠va itt */
        #jewelry-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
            perspective: 1000px; /* 3D perspekt√≠va */
            perspective-origin: center center;
        }
        
        /* Maga az √©kszer k√©p */
        #jewelry-image {
            position: absolute;
            display: none; /* Kezdetben rejtve */
            transform-origin: center center;
            will-change: transform, opacity;
            transition: opacity 0.2s ease-out;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.4)) 
                    drop-shadow(0 6px 6px rgba(0,0,0,0.3));
            max-width: none; /* Fontos: ne szab√°lyozza a CSS a m√©retet */
            pointer-events: none;
        }
        
        /* Szaggatott vonal (occlusion) */
        #occlusion-indicator {
            position: absolute;
            display: none;
            pointer-events: none;
            z-index: 11;
            opacity: 0;
            transition: opacity 0.2s ease-out;
        }
        
        #occlusion-indicator svg {
            overflow: visible;
        }
        
        #occlusion-indicator ellipse {
            fill: none;
            stroke: rgba(255, 255, 255, 0.8);
            stroke-width: 2;
            stroke-dasharray: 8, 4;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }
        
        /* UI Panel */
        #ui-panel {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            min-width: 280px;
        }
        
        #ui-panel label {
            color: white;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
        }
        
        #file-input {
            display: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            width: 100%;
            text-align: center;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        #status-text {
            color: rgba(255,255,255,0.7);
            font-size: 12px;
            margin-top: 5px;
            text-align: center;
        }
        
        /* Loading */
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            z-index: 1000;
            font-size: 16px;
            background: rgba(0,0,0,0.8);
            padding: 20px 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Debug info (opcion√°lis, fejleszt√©shez) */
        #debug-info {
            position: fixed;
            top: 10px;
            left: 10px;
            color: rgba(255,255,255,0.5);
            font-size: 10px;
            z-index: 1000;
            font-family: monospace;
            pointer-events: none;
            display: none; /* Bekapcsolhat√≥ ha kell */
        }
    </style>
</head>
<body>

    <!-- Kamera input -->
    <video id="input_video" playsinline></video>
    
    <!-- 3D √âkszer kont√©ner -->
    <div id="jewelry-container">
        <img id="jewelry-image" src="" alt="Jewelry">
    </div>
    
    <!-- Szaggatott vonal indik√°tor -->
    <div id="occlusion-indicator">
        <svg width="200" height="100" viewBox="0 0 200 100">
            <ellipse cx="100" cy="50" rx="90" ry="20" />
        </svg>
    </div>
    
    <!-- Loading screen -->
    <div id="loading">
        <div class="spinner"></div>
        <span>Kamera inicializ√°l√°sa...</span>
    </div>
    
    <!-- Debug info -->
    <div id="debug-info"></div>
    
    <!-- UI Panel -->
    <div id="ui-panel">
        <label>üìø T√∂lts fel egy √©kszer k√©pet (PNG)</label>
        <input type="file" id="file-input" accept="image/png,image/jpeg">
        <button class="btn" onclick="document.getElementById('file-input').click()">
            K√©p kiv√°laszt√°sa
        </button>
        <div id="status-text">V√°rakoz√°s a k√©zre...</div>
    </div>

    <script>
        // Konfigur√°ci√≥
        const CONFIG = {
            smoothFactor: 0.15,        // Lerp faktor (0.1 = lass√∫, 0.3 = gyors)
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.7,
            maxRotationX: 25,          // Max d√∂nt√©s el≈ëre/h√°tra (fok)
            maxRotationY: 15,          // Max d√∂nt√©s oldalra
            scaleFactor: 2.5,          // Alap sk√°l√°z√°s
            occlusionThreshold: 0.6,   // Frontalit√°s k√ºsz√∂b (0-1)
            jewelryYOffset: -0.05      // F√ºgg≈ëleges eltol√°s a csukl√≥hoz k√©pest (%)
        };

        // State
        let state = {
            targetX: window.innerWidth / 2,
            targetY: window.innerHeight / 2,
            targetRotationZ: 0,
            targetRotationX: 0,
            targetRotationY: 0,
            targetScale: 1,
            currentX: window.innerWidth / 2,
            currentY: window.innerHeight / 2,
            currentRotationZ: 0,
            currentRotationX: 0,
            currentRotationY: 0,
            currentScale: 1,
            visibility: 0,
            hasImage: false,
            isFrontal: true
        };

        // DOM elemek
        const videoElement = document.getElementById('input_video');
        const jewelryImage = document.getElementById('jewelry-image');
        const jewelryContainer = document.getElementById('jewelry-container');
        const occlusionIndicator = document.getElementById('occlusion-indicator');
        const fileInput = document.getElementById('file-input');
        const statusText = document.getElementById('status-text');
        const loadingScreen = document.getElementById('loading');
        const debugInfo = document.getElementById('debug-info');

        // K√©p felt√∂lt√©s kezel√©se
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    jewelryImage.src = event.target.result;
                    jewelryImage.onload = () => {
                        state.hasImage = true;
                        jewelryImage.style.display = 'block';
                        statusText.textContent = '√âkszer bet√∂ltve. Mozgasd a kezed!';
                    };
                };
                reader.readAsDataURL(file);
            }
        });

        // Lerp f√ºggv√©ny (sim√≠t√°s)
        function lerp(start, end, factor) {
            return start + (end - start) * factor;
        }

        // Vektor m≈±veletek
        function getDistance(p1, p2) {
            return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
        }

        function getAngle(p1, p2) {
            return Math.atan2(p2.y - p1.y, p2.x - p1.x);
        }

        // Frontalit√°s sz√°m√≠t√°s (mennyire n√©z szemb≈ël a k√©z)
        // Ha a k√©z szemb≈ël n√©z, a sz√©less√©ge nagyobb, ha oldalra fordul, keskenyebb
        function calculateFrontality(landmarks) {
            const wrist = landmarks[0];
            const thumbBase = landmarks[2];
            const pinkyBase = landmarks[17];
            
            // K√©z sz√©less√©g (h√ºvelykujj alap - kisujj alap)
            const handWidth = getDistance(thumbBase, pinkyBase);
            
            // K√©z hossza (csukl√≥ - k√∂z√©ps≈ë ujj v√©ge)
            const handLength = getDistance(wrist, landmarks[12]);
            
            // Ar√°ny: sz√©less√©g / hossz
            // Szemb≈ël n√©zve ez nagyobb (0.8-1.0), oldalr√≥l n√©zve kisebb (0.3-0.5)
            const ratio = handWidth / handLength;
            
            // Normaliz√°l√°s 0-1 k√∂z√© (empirikus √©rt√©kek)
            const frontal = Math.min(Math.max((ratio - 0.4) / 0.4, 0), 1);
            
            return frontal;
        }

        // MediaPipe eredm√©ny feldolgoz√°sa
        function onResults(results) {
            loadingScreen.style.display = 'none';
            
            if (!state.hasImage || !results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                // Nincs k√©p vagy nincs k√©z - fade out
                state.visibility = 0;
                updateJewelry();
                statusText.textContent = 'V√°rakoz√°s a k√©zre...';
                return;
            }

            const landmarks = results.multiHandLandmarks[0];
            
            // Landmarkok
            const wrist = landmarks[0];
            const middleFingerBase = landmarks[9];
            const middleFingerTip = landmarks[12];
            const thumbBase = landmarks[2];
            const pinkyBase = landmarks[17];
            
            // Csukl√≥ k√∂z√©ppont (kiss√© felfel√© tolva, hogy a kark√∂t≈ë ne a csonton legyen)
            const centerX = (wrist.x + middleFingerBase.x) / 2;
            const centerY = (wrist.y + middleFingerBase.y) / 2 + CONFIG.jewelryYOffset;
            
            // K√©perny≈ë koordin√°t√°kra konvert√°l√°s (t√ºkr√∂zve, mert a video t√ºkr√∂z√∂tt)
            const screenX = (1 - centerX) * window.innerWidth; // T√ºk√∂rk√©p kompenz√°ci√≥
            const screenY = centerY * window.innerHeight;
            
            // Forgat√°s Z tengely k√∂r√ºl (k√©z elfordul√°sa)
            const handAngle = getAngle(wrist, middleFingerBase);
            const rotationZ = handAngle + Math.PI / 2; // +90 fok, hogy v√≠zszintes legyen
            
            // Sk√°l√°z√°s (t√°vols√°g becsl√©s a k√©z m√©ret√©b≈ël)
            const handSize = getDistance(wrist, middleFingerBase);
            const baseSize = 0.15; // Norm√°l k√©zm√©ret ar√°ny
            const scale = (handSize / baseSize) * CONFIG.scaleFactor;
            
            // Frontalit√°s √©s X/Y rot√°ci√≥ (3D hat√°s)
            const frontality = calculateFrontality(landmarks);
            
            // D√∂nt√©s X tengely k√∂r√ºl (hajl√≠t√°s) - a k√©z "billen√©s√©b≈ël" sz√°molva
            // Ha a k√©zfej felfel√© n√©z vs. lefel√©
            const handTilt = (middleFingerTip.y - wrist.y) / handSize;
            const rotationX = Math.max(-CONFIG.maxRotationX, 
                             Math.min(CONFIG.maxRotationX, handTilt * 20));
            
            // D√∂nt√©s Y tengely k√∂r√ºl (oldalra) - a k√©z sz√©less√©g√©b≈ël becsl√©s
            const handLean = (thumbBase.x - pinkyBase.x) / handSize;
            const rotationY = Math.max(-CONFIG.maxRotationY,
                             Math.min(CONFIG.maxRotationY, handLean * 15));
            
            // C√©l √©rt√©kek be√°ll√≠t√°sa
            state.targetX = screenX;
            state.targetY = screenY;
            state.targetRotationZ = rotationZ * (180 / Math.PI); // Radian to degree
            state.targetRotationX = rotationX;
            state.targetRotationY = rotationY;
            state.targetScale = scale;
            state.isFrontal = frontality > CONFIG.occlusionThreshold;
            
            // Ha front√°lis, akkor l√°that√≥, ha nem, akkor occlusion
            if (state.isFrontal) {
                state.visibility = 1;
                statusText.textContent = '√âkszer akt√≠v';
            } else {
                state.visibility = 0;
                statusText.textContent = 'Ford√≠tsd szembe a kezed';
            }
            
            // Debug info
            debugInfo.innerHTML = `
                Frontality: ${frontality.toFixed(2)}<br>
                Scale: ${scale.toFixed(2)}<br>
                RotX: ${rotationX.toFixed(1)}¬∞
            `;
        }

        // √âkszer megjelen√≠t√©s friss√≠t√©se (anim√°ci√≥s loop)
        function updateJewelry() {
            // Sim√≠t√°s (Lerp)
            state.currentX = lerp(state.currentX, state.targetX, CONFIG.smoothFactor);
            state.currentY = lerp(state.currentY, state.targetY, CONFIG.smoothFactor);
            state.currentRotationZ = lerp(state.currentRotationZ, state.targetRotationZ, CONFIG.smoothFactor);
            state.currentRotationX = lerp(state.currentRotationX, state.targetRotationX, CONFIG.smoothFactor);
            state.currentRotationY = lerp(state.currentRotationY, state.targetRotationY, CONFIG.smoothFactor);
            state.currentScale = lerp(state.currentScale, state.targetScale, CONFIG.smoothFactor);
            
            // L√°that√≥s√°g kezel√©se
            if (state.visibility > 0.5) {
                // √âkszer l√°that√≥
                jewelryImage.style.opacity = '1';
                occlusionIndicator.style.opacity = '0';
                
                // CSS 3D Transzform√°ci√≥
                // translate3d a poz√≠ci√≥hoz, rotateX/Y/Z a 3D orient√°ci√≥hoz, scale a m√©retar√°nyhoz
                const transform = `
                    translate3d(${state.currentX}px, ${state.currentY}px, 0)
                    translate(-50%, -50%)
                    rotateZ(${state.currentRotationZ}deg)
                    rotateX(${state.currentRotationX}deg)
                    rotateY(${state.currentRotationY}deg)
                    scale(${state.currentScale})
                `;
                
                jewelryImage.style.transform = transform;
                jewelryImage.style.left = '0';
                jewelryImage.style.top = '0';
                
            } else {
                // √âkszer elt≈±nt, szaggatott vonal megjelen√≠t√©se
                jewelryImage.style.opacity = '0';
                
                // Szaggatott vonal pozicion√°l√°sa
                if (state.hasImage) {
                    occlusionIndicator.style.display = 'block';
                    occlusionIndicator.style.left = state.currentX + 'px';
                    occlusionIndicator.style.top = state.currentY + 'px';
                    occlusionIndicator.style.transform = `translate(-50%, -50%) rotate(${state.currentRotationZ}deg) scale(${state.currentScale})`;
                    occlusionIndicator.style.opacity = '0.8';
                }
            }
            
            requestAnimationFrame(updateJewelry);
        }

        // MediaPipe inicializ√°l√°s
        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1, // 0 = gyorsabb, 1 = pontosabb
            minDetectionConfidence: CONFIG.minDetectionConfidence,
            minTrackingConfidence: CONFIG.minTrackingConfidence
        });

        hands.onResults(onResults);

        // Kamera inicializ√°l√°s
        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 1280,
            height: 720
        });

        // Ind√≠t√°s
        camera.start()
            .then(() => {
                console.log('Kamera elindult');
                loadingScreen.style.display = 'none';
            })
            .catch(err => {
                console.error('Kamera hiba:', err);
                loadingScreen.innerHTML = '<span>Kamera hiba! Enged√©lyezd a kamer√°t.</span>';
            });

        // Anim√°ci√≥s loop ind√≠t√°sa
        updateJewelry();

        // Window resize kezel√©s
        window.addEventListener('resize', () => {
            // Nem kell semmit tenni, a koordin√°t√°k dinamikusan sz√°m√≠t√≥dnak
        });

        // Double tap a debug m√≥dhoz (fejleszt√©shez)
        let lastTap = 0;
        document.addEventListener('touchend', (e) => {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 500 && tapLength > 0) {
                debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
                e.preventDefault();
            }
            lastTap = currentTime;
        });
    </script>
</body>
</html>
