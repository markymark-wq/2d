<!-- 
  2D Overlay
  cosmic-engine | 2026-02-04
  Egyszer≈± 2D k√©pk√∂vet√©s MediaPipe Hands-sel
-->
<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>√âkszer AR - Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            overflow: hidden;
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            touch-action: none;
        }
        
        #video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 1;
        }
        
        #input_video {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        
        #scene-3d {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            perspective: 1200px;
            overflow: hidden;
        }
        
        #wrist-anchor {
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 0;
            transform-style: preserve-3d;
            will-change: transform;
        }
        
        #jewelry-card {
            position: absolute;
            transform-style: preserve-3d;
            backface-visibility: hidden;
            transition: none;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5));
        }
        
        #jewelry-img {
            display: block;
            max-width: none;
            max-height: none;
            transform: translate(-50%, -50%);
        }
        
        #dashed-line {
            position: absolute;
            border: 3px dashed rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: none;
            pointer-events: none;
            box-shadow: 0 0 20px rgba(0,0,0,0.8), inset 0 0 15px rgba(255,255,255,0.3);
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
        }
        
        #ui-layer {
            position: fixed;
            z-index: 100;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .top-controls {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            pointer-events: auto;
        }
        
        .top-btn {
            background: rgba(0,0,0,0.7);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }
        
        .main-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: auto;
            width: 90%;
            max-width: 400px;
        }
        
        .mode-selector {
            display: flex;
            gap: 10px;
            background: rgba(0,0,0,0.7);
            padding: 8px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .mode-btn {
            flex: 1;
            background: transparent;
            color: rgba(255,255,255,0.7);
            border: none;
            padding: 12px;
            border-radius: 18px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mode-btn.active {
            background: rgba(255,255,255,0.95);
            color: #000;
        }
        
        .finger-controls {
            display: none;
            gap: 10px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            align-items: center;
            justify-content: center;
        }
        
        .finger-controls.visible {
            display: flex;
        }
        
        .finger-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .finger-label {
            color: white;
            font-size: 14px;
            font-weight: 600;
            min-width: 100px;
            text-align: center;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            flex: 1;
            background: rgba(255,255,255,0.95);
            color: #000;
            border: none;
            padding: 14px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
        }
        
        #file-input {
            display: none;
        }
        
        .instructions {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            font-size: 16px;
            opacity: 0.8;
            pointer-events: none;
            text-shadow: 0 2px 4px rgba(0,0,0,0.9);
            width: 80%;
            line-height: 1.5;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            z-index: 1000;
            display: none;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
        }
    </style>
</head>
<body>

    <div class="loading" id="loading">Kamera inicializ√°l√°sa...</div>

    <div id="video-container">
        <video id="input_video" playsinline></video>
    </div>

    <div id="scene-3d">
        <div id="wrist-anchor">
            <div id="jewelry-card">
                <img id="jewelry-img" src="" alt="jewelry" style="display:none;">
            </div>
        </div>
        <div id="dashed-line"></div>
    </div>

    <div class="instructions" id="instructions">
        V√°lassz m√≥dot √©s t√∂lts fel egy √©kszer k√©pet<br>
        <small>PNG form√°tum, √°tl√°tsz√≥ h√°tt√©rrel</small>
    </div>

    <div id="ui-layer">
        <div class="top-controls">
            <button class="top-btn" onclick="toggleMirror()">üîÑ T√ºk√∂r</button>
            <button class="top-btn" onclick="toggleCamera()">üì∑ Kamera</button>
        </div>
        
        <div class="main-controls">
            <div class="mode-selector">
                <button class="mode-btn active" id="btn-bracelet" onclick="setMode('bracelet')">üìø Kark√∂t≈ë</button>
                <button class="mode-btn" id="btn-ring" onclick="setMode('ring')">üíç Gy≈±r≈±</button>
            </div>
            
            <div class="finger-controls" id="finger-controls">
                <button class="finger-btn" onclick="prevFinger()">‚óÄ</button>
                <div class="finger-label" id="finger-label">Gy≈±r≈±sujj</div>
                <button class="finger-btn" onclick="nextFinger()">‚ñ∂</button>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="document.getElementById('file-input').click()">üìÅ Felt√∂lt√©s</button>
                <button class="action-btn" onclick="resetJewelry()">üóëÔ∏è T√∂rl√©s</button>
            </div>
        </div>
    </div>

    <input type="file" id="file-input" accept="image/png,image/jpeg,image/webp" onchange="handleFileSelect(event)">

    <script>
        // Konfigur√°ci√≥
        const CONFIG = {
            smoothing: 0.15,
            transitionStart: 30, // Fok, ahol elkezd≈ëdik az √°tmenet
            transitionEnd: 45,   // Fok, ahol teljesen √°tv√°lt a vonalra
            baseScaleBracelet: 2.8, // Kark√∂t≈ë sk√°la alap
            baseScaleRing: 0.8,     // Gy≈±r≈± sk√°la alap (ujjhoz k√©pest)
        };

        // State
        let currentMode = 'bracelet'; // 'bracelet' vagy 'ring'
        let currentFingerIndex = 2; // 0=mutat√≥, 1=k√∂z√©ps≈ë, 2=gy≈±r≈±s, 3=kisujj
        const fingerNames = ['Mutat√≥ujj', 'K√∂z√©ps≈ëujj', 'Gy≈±r≈±sujj', 'Kisujj'];
        const fingerLandmarks = [
            { tip: 8, base: 5 },   // Mutat√≥
            { tip: 12, base: 9 },  // K√∂z√©ps≈ë
            { tip: 16, base: 13 }, // Gy≈±r≈±s
            { tip: 20, base: 17 }  // Kisujj
        ];
        
        let currentCamera = 'environment';
        let isMirrored = true;
        let hasJewelry = false;
        let isVideoReady = false;
        
        let state = {
            x: window.innerWidth / 2,
            y: window.innerHeight / 2,
            rotX: 0,
            rotY: 0,
            rotZ: 0,
            scale: 1,
            visibility: 0, // 0-1 k√∂z√∂tt (1 = t√∂k√©letesen l√°that√≥)
            yaw: 0         // Aktu√°lis yaw sz√∂g fokban
        };

        let target = {
            x: window.innerWidth / 2,
            y: window.innerHeight / 2,
            rotX: 0,
            rotY: 0,
            rotZ: 0,
            scale: 1,
            visibility: 0,
            yaw: 0
        };

        // DOM
        const videoElement = document.getElementById('input_video');
        const wristAnchor = document.getElementById('wrist-anchor');
        const jewelryCard = document.getElementById('jewelry-card');
        const jewelryImg = document.getElementById('jewelry-img');
        const dashedLine = document.getElementById('dashed-line');
        const instructions = document.getElementById('instructions');
        const fingerControls = document.getElementById('finger-controls');
        const fingerLabel = document.getElementById('finger-label');
        const btnBracelet = document.getElementById('btn-bracelet');
        const btnRing = document.getElementById('btn-ring');

        // MediaPipe
        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onResults);

        // Inicializ√°l√°s
        function initCamera() {
            document.getElementById('loading').style.display = 'block';
            
            if (window.camera) window.camera.stop();

            window.camera = new Camera(videoElement, {
                onFrame: async () => {
                    await hands.send({image: videoElement});
                },
                width: 1280,
                height: 720,
                facingMode: currentCamera
            });
            
            window.camera.start()
                .then(() => {
                    document.getElementById('loading').style.display = 'none';
                    isVideoReady = true;
                    updateMirror();
                })
                .catch(err => {
                    console.error('Kamera hiba:', err);
                    alert('Kamera hozz√°f√©r√©s sz√ºks√©ges!');
                });
        }

        function toggleMirror() {
            isMirrored = !isMirrored;
            updateMirror();
        }

        function toggleCamera() {
            currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
            initCamera();
        }

        function updateMirror() {
            videoElement.style.transform = isMirrored ? 'scaleX(-1)' : 'scaleX(1)';
        }

        function setMode(mode) {
            currentMode = mode;
            if (mode === 'bracelet') {
                btnBracelet.classList.add('active');
                btnRing.classList.remove('active');
                fingerControls.classList.remove('visible');
            } else {
                btnBracelet.classList.remove('active');
                btnRing.classList.add('active');
                fingerControls.classList.add('visible');
            }
            updateFingerLabel();
        }

        function nextFinger() {
            currentFingerIndex = (currentFingerIndex + 1) % 4;
            updateFingerLabel();
        }

        function prevFinger() {
            currentFingerIndex = (currentFingerIndex - 1 + 4) % 4;
            updateFingerLabel();
        }

        function updateFingerLabel() {
            fingerLabel.textContent = fingerNames[currentFingerIndex];
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    jewelryImg.src = e.target.result;
                    jewelryImg.onload = () => {
                        hasJewelry = true;
                        jewelryImg.style.display = 'block';
                        instructions.style.display = 'none';
                    };
                };
                reader.readAsDataURL(file);
            }
        }

        function resetJewelry() {
            hasJewelry = false;
            jewelryImg.src = '';
            jewelryImg.style.display = 'none';
            instructions.style.display = 'block';
            state.visibility = 0;
            target.visibility = 0;
        }

        function lerp(start, end, factor) {
            return start + (end - start) * factor;
        }

        function clamp(val, min, max) {
            return Math.min(Math.max(val, min), max);
        }

        // F≈ë feldolgoz√≥
        function onResults(results) {
            if (!hasJewelry || !isVideoReady) return;

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                
                let centerX, centerY, rotZ, yawDeg, scale;
                
                if (currentMode === 'bracelet') {
                    // KARK√ñT≈ê: Csukl√≥ (0) √©s k√∂z√©ps≈ë ujj alap (9) k√∂z√©p
                    const wrist = lm[0];
                    const middle = lm[9];
                    const index = lm[5];
                    const pinky = lm[17];
                    
                    let cx = (wrist.x + middle.x) / 2;
                    let cy = (wrist.y + middle.y) / 2;
                    
                    if (isMirrored) cx = 1 - cx;
                    
                    centerX = cx * window.innerWidth;
                    centerY = cy * window.innerHeight;
                    
                    // Forgat√°s (Roll)
                    const dx = middle.x - wrist.x;
                    const dy = middle.y - wrist.y;
                    rotZ = Math.atan2(dy, dx) * (180 / Math.PI) + 90;
                    if (isMirrored) rotZ = -rotZ;
                    
                    // Yaw (oldalra fordul√°s) a teny√©r sz√©less√©g√©b≈ël
                    const handWidth = Math.sqrt(Math.pow(index.x - pinky.x, 2) + Math.pow(index.y - pinky.y, 2));
                    const handHeight = Math.sqrt(Math.pow(wrist.x - middle.x, 2) + Math.pow(wrist.y - middle.y, 2));
                    const aspect = handWidth / handHeight;
                    
                    // Aspect 1.0 = front, 0.4 = oldal (90¬∞)
                    const yawFactor = (aspect - 0.4) / 0.6;
                    yawDeg = (1 - clamp(yawFactor, 0, 1)) * 90;
                    if (index.x > pinky.x) yawDeg = -yawDeg;
                    if (isMirrored) yawDeg = -yawDeg;
                    
                    // Sk√°la: K√©z sz√©less√©g alapj√°n
                    const refSize = handWidth * window.innerWidth;
                    scale = (refSize * CONFIG.baseScaleBracelet) / jewelryImg.naturalWidth;
                    
                } else {
                    // GY≈∞R≈∞: Aktu√°lis ujj
                    const finger = fingerLandmarks[currentFingerIndex];
                    const tip = lm[finger.tip];
                    const base = lm[finger.base];
                    
                    // Poz√≠ci√≥: Ujj k√∂zepe (egy kicsit k√∂zelebb a b√°zishoz, hogy ne a k√∂r√∂m√∂n legyen)
                    let cx = (base.x + tip.x) / 2;
                    let cy = (base.y + tip.y) / 2;
                    
                    // Finomhangol√°s: egy kicsit a b√°zis fel√© toljuk (30% ar√°ny)
                    cx = base.x * 0.7 + tip.x * 0.3;
                    cy = base.y * 0.7 + tip.y * 0.3;
                    
                    if (isMirrored) cx = 1 - cx;
                    
                    centerX = cx * window.innerWidth;
                    centerY = cy * window.innerHeight;
                    
                    // Forgat√°s: Ujj ir√°nya
                    const dx = tip.x - base.x;
                    const dy = tip.y - base.y;
                    rotZ = Math.atan2(dy, dx) * (180 / Math.PI) + 90;
                    if (isMirrored) rotZ = -rotZ;
                    
                    // Gy≈±r≈±n√©l nincs bonyolult yaw sz√°m√≠t√°s, egyszer≈±bb approxim√°ci√≥
                    // Az ujj "sz√©less√©g√©b≈ël" becs√ºlj√ºk az oldalra fordul√°st
                    const neighbor = currentFingerIndex < 3 ? fingerLandmarks[currentFingerIndex + 1] : fingerLandmarks[2];
                    const sideDist = Math.sqrt(Math.pow(base.x - lm[neighbor.base].x, 2) + Math.pow(base.y - lm[neighbor.base].y, 2));
                    const fingerLen = Math.sqrt(Math.pow(tip.x - base.x, 2) + Math.pow(tip.y - base.y, 2));
                    const aspect = sideDist / fingerLen;
                    
                    const yawFactor = (aspect - 0.3) / 0.4;
                    yawDeg = (1 - clamp(yawFactor, 0, 1)) * 60; // Gy≈±r≈±n√©l kisebb sz√∂g is el√©g
                    
                    // Sk√°la: Ujj vastags√°ga alapj√°n (fix m√©ret, nem t√°vols√°g f√ºgg≈ë annyira)
                    const fingerWidth = sideDist * window.innerWidth;
                    scale = (fingerWidth * CONFIG.baseScaleRing) / (jewelryImg.naturalWidth / 2);
                }
                
                // Pitch (fel-le d√∂nt√©s) - egyszer≈±s√≠tett
                const pitch = 0; // K√©s≈ëbb finom√≠that√≥
                
                // Visibility sz√°m√≠t√°s (0-1)
                // 0-30¬∞: 1.0 (t√∂k√©letes)
                // 30-45¬∞: 1.0 -> 0.0 (√°tmenet)
                // 45¬∞+: 0.0 (csak vonal)
                const absYaw = Math.abs(yawDeg);
                let visibility = 1.0;
                if (absYaw > CONFIG.transitionEnd) {
                    visibility = 0.0;
                } else if (absYaw > CONFIG.transitionStart) {
                    visibility = 1.0 - ((absYaw - CONFIG.transitionStart) / (CONFIG.transitionEnd - CONFIG.transitionStart));
                }
                
                // C√©lok be√°ll√≠t√°sa
                target.x = centerX;
                target.y = centerY;
                target.rotZ = rotZ;
                target.rotY = yawDeg; // Yaw a Y tengely k√∂r√ºli forgat√°s
                target.rotX = pitch;
                target.scale = clamp(scale, 0.3, 3.0);
                target.visibility = visibility;
                target.yaw = absYaw;
                
            } else {
                target.visibility = 0;
                target.yaw = 90;
            }
        }

        // Anim√°ci√≥
        function animate() {
            // Sim√≠t√°s
            state.x = lerp(state.x, target.x, CONFIG.smoothing);
            state.y = lerp(state.y, target.y, CONFIG.smoothing);
            state.rotZ = lerp(state.rotZ, target.rotZ, CONFIG.smoothing);
            state.rotY = lerp(state.rotY, target.rotY, CONFIG.smoothing);
            state.rotX = lerp(state.rotX, target.rotX, CONFIG.smoothing);
            state.scale = lerp(state.scale, target.scale, CONFIG.smoothing);
            state.visibility = lerp(state.visibility, target.visibility, CONFIG.smoothing);
            state.yaw = lerp(state.yaw, target.yaw, CONFIG.smoothing);
            
            if (!hasJewelry) {
                requestAnimationFrame(animate);
                return;
            }
            
            // FOLYAMOS √ÅTMENET 30-45¬∞ k√∂z√∂tt
            // 0-30¬∞: √âkszer 100%, vonal 0%
            // 30-45¬∞: √âkszer 100% -> 0%, vonal 0% -> 100%
            // 45¬∞+: √âkszer 0%, vonal 100%
            
            let jewelryOpacity = 1.0;
            let lineOpacity = 0.0;
            let lineScale = 1.0;
            
            if (state.yaw <= CONFIG.transitionStart) {
                jewelryOpacity = 1.0;
                lineOpacity = 0.0;
            } else if (state.yaw >= CONFIG.transitionEnd) {
                jewelryOpacity = 0.0;
                lineOpacity = 1.0;
            } else {
                // √Åtmeneti z√≥na (30-45¬∞)
                const t = (state.yaw - CONFIG.transitionStart) / (CONFIG.transitionEnd - CONFIG.transitionStart);
                jewelryOpacity = 1.0 - t; // Line√°ris cs√∂kken√©s
                lineOpacity = t;          // Line√°ris n√∂veked√©s
                lineScale = 0.8 + (t * 0.4); // A vonal kicsit n≈ë, ahogy k√∂zelebb ker√ºl
            }
            
            // 90¬∞-n√°l (backface) teljesen elrejtj√ºk az √©kszert
            if (Math.abs(state.rotY) > 85) {
                jewelryOpacity = 0;
            }
            
            // Pozicion√°l√°s
            wristAnchor.style.transform = `translate3d(${state.x}px, ${state.y}px, 0)`;
            
            // √âkszer transzform√°ci√≥
            jewelryCard.style.transform = `
                rotateY(${state.rotY}deg) 
                rotateX(${-state.rotX}deg) 
                rotateZ(${state.rotZ}deg) 
                scale(${state.scale})
            `;
            jewelryCard.style.opacity = jewelryOpacity;
            
            // Szaggatott vonal kezel√©se
            if (lineOpacity > 0.01) {
                dashedLine.style.display = 'block';
                dashedLine.style.left = state.x + 'px';
                dashedLine.style.top = state.y + 'px';
                dashedLine.style.opacity = lineOpacity;
                
                // A vonal m√©rete a m√≥dt√≥l f√ºgg≈ëen v√°ltozik
                const baseSize = currentMode === 'bracelet' ? 80 : 40;
                const size = baseSize * lineScale * (currentMode === 'bracelet' ? 1.5 : 1.0);
                dashedLine.style.width = size + 'px';
                dashedLine.style.height = (currentMode === 'bracelet' ? size * 0.8 : size) + 'px';
            } else {
                dashedLine.style.display = 'none';
            }
            
            requestAnimationFrame(animate);
        }

        // Start
        initCamera();
        animate();
        updateFingerLabel();
    </script>
</body>
</html>
