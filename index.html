<!-- 
  2D Overlay
  cosmic-engine | 2026-02-04
  Egyszer≈± 2D k√©pk√∂vet√©s MediaPipe Hands-sel
-->
<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2D VTO - Ultimate Edition</title>
    <!-- MediaPipe Hands -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            overflow: hidden;
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            touch-action: none;
        }

        /* --- VIDEO LAYER --- */
        #video-container {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; z-index: 1;
        }
        #input_video {
            position: absolute; width: 100%; height: 100%;
            object-fit: cover;
            /* T√ºk√∂rk√©p alapbe√°ll√≠t√°s */
            transform: scaleX(-1);
        }

        /* --- 3D SCENE LAYER --- */
        /* Ez a r√©teg adja a m√©lys√©get */
        #scene-3d {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            /* CSS 3D Perspective: a kulcs a t√©rhat√°shoz */
            perspective: 1200px;
            overflow: hidden;
        }

        /* Az √©kszer horgonypontja (k√∂veti a k√©z poz√≠ci√≥j√°t) */
        #wrist-anchor {
            position: absolute; top: 0; left: 0; width: 0; height: 0;
            transform-style: preserve-3d;
            will-change: transform;
        }

        /* Az √©kszer k√°rtya (k√©rd≈ë√≠v, d√∂nt√©s) */
        #jewelry-card {
            position: absolute;
            transform-style: preserve-3d;
            /* Ha a k√©z h√°trafordul, ne l√°tsz√≥djon a h√°ta */
            backface-visibility: hidden; 
            transition: none; /* Anim√°ci√≥t a JS-ben csin√°ljuk lerp-el */
            /* Drop Shadow a realit√°s√©rt */
            filter: drop-shadow(0 12px 25px rgba(0,0,0,0.6));
        }

        #jewelry-img {
            display: block; max-width: none; max-height: none;
            /* K√©p k√∂z√©ppontos√≠t√°sa az anchorhoz */
            transform: translate(-50%, -50%);
        }

        /* Szaggatott vonal (Occlusion indicator) */
        #dashed-line {
            position: absolute;
            border: 3px dashed rgba(255, 255, 255, 0.95);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: none;
            pointer-events: none;
            box-shadow: 0 0 25px rgba(0,0,0,0.9), inset 0 0 15px rgba(255,255,255,0.3);
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }

        /* --- UI LAYER --- */
        #ui-layer {
            position: fixed; z-index: 100; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
        }

        /* Gombok St√≠lusa */
        .btn {
            pointer-events: auto;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            font-weight: 600; cursor: pointer;
            transition: transform 0.1s, background 0.2s;
        }
        .btn:active { transform: scale(0.95); }

        /* Fels≈ë vez√©rl≈ëk */
        .top-controls {
            position: absolute; top: 20px; left: 0; width: 100%;
            display: flex; justify-content: space-between; padding: 0 20px;
        }
        .icon-btn {
            background: rgba(0,0,0,0.6); color: white;
            padding: 10px 16px; border-radius: 20px; font-size: 13px;
        }

        /* Als√≥ vez√©rl≈ëk */
        .main-controls {
            position: absolute; bottom: 30px; left: 50%;
            transform: translateX(-50%);
            width: 90%; max-width: 400px;
            display: flex; flex-direction: column; gap: 12px;
            pointer-events: auto;
        }

        /* M√≥d v√°laszt√≥ (Kark√∂t≈ë / Gy≈±r≈±) */
        .mode-selector {
            display: flex; gap: 10px;
            background: rgba(0,0,0,0.7);
            padding: 8px; border-radius: 25px;
        }
        .mode-btn {
            flex: 1; background: transparent; color: rgba(255,255,255,0.6);
            border: none; padding: 12px; border-radius: 18px; font-size: 14px;
            cursor: pointer; transition: all 0.3s;
        }
        .mode-btn.active {
            background: rgba(255,255,255,0.95); color: #000; font-weight: 700;
        }

        /* Ujj v√°laszt√≥ (csak gy≈±r≈± m√≥dn√°l) */
        .finger-controls {
            display: none; gap: 10px;
            background: rgba(0,0,0,0.7);
            padding: 10px; border-radius: 25px;
            align-items: center; justify-content: center;
        }
        .finger-controls.visible { display: flex; }
        .finger-btn {
            background: rgba(255,255,255,0.2); color: white;
            border: none; width: 40px; height: 40px; border-radius: 50%;
            font-size: 18px; cursor: pointer;
        }
        .finger-label {
            color: white; font-size: 14px; font-weight: 600;
            min-width: 100px; text-align: center;
        }

        /* Akci√≥ gombok */
        .action-group {
            display: flex; gap: 10px;
        }
        .action-btn {
            flex: 1; background: rgba(255,255,255,0.95);
            color: #000; border: none; padding: 14px; border-radius: 20px;
            font-size: 14px; font-weight: 700;
        }

        /* Rejtett input */
        #file-input { display: none; }

        /* Seg√©d sz√∂vegek */
        .instructions {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: white; text-align: center; font-size: 16px;
            opacity: 0.8; pointer-events: none;
            text-shadow: 0 2px 4px rgba(0,0,0,0.9);
            width: 80%; line-height: 1.5;
        }
        .loading {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); color: white; z-index: 1000;
            display: none; background: rgba(0,0,0,0.8);
            padding: 20px; border-radius: 10px;
        }
    </style>
</head>
<body>

    <div class="loading" id="loading">Kamera inicializ√°l√°sa...</div>

    <!-- 1. Kamera h√°tt√©r -->
    <div id="video-container">
        <video id="input_video" playsinline></video>
    </div>

    <!-- 2. 3D R√©teg -->
    <div id="scene-3d">
        <div id="wrist-anchor">
            <div id="jewelry-card">
                <img id="jewelry-img" src="" alt="jewelry" style="display:none;">
            </div>
        </div>
        <!-- Szaggatott vonal a "nem l√°that√≥" oldal jelz√©s√©re -->
        <div id="dashed-line"></div>
    </div>

    <div class="instructions" id="instructions">
        V√°lassz m√≥dot √©s t√∂lts fel egy √©kszer k√©pet (PNG)<br>
        <small>A kark√∂t≈ënek √©s a gy≈±r≈±nek k√ºl√∂n f√°jlok kellenek.</small>
    </div>

    <!-- 3. UI Vez√©rl≈ëk -->
    <div id="ui-layer">
        <!-- Fent -->
        <div class="top-controls">
            <button class="btn icon-btn" onclick="toggleMirror()">üîÑ T√ºk√∂r</button>
            <button class="btn icon-btn" onclick="toggleCamera()">üì∑ Kamera</button>
        </div>
        
        <!-- Lent -->
        <div class="main-controls">
            <!-- M√≥d v√°laszt√≥ -->
            <div class="mode-selector">
                <button class="mode-btn active" id="btn-bracelet" onclick="setMode('bracelet')">üìø Kark√∂t≈ë</button>
                <button class="mode-btn" id="btn-ring" onclick="setMode('ring')">üíç Gy≈±r≈±</button>
            </div>
            
            <!-- Ujj v√°laszt√≥ (Rejtett alapb√≥l) -->
            <div class="finger-controls" id="finger-controls">
                <button class="finger-btn" onclick="prevFinger()">‚óÄ</button>
                <div class="finger-label" id="finger-label">Gy≈±r≈±sujj</div>
                <button class="finger-btn" onclick="nextFinger()">‚ñ∂</button>
            </div>
            
            <!-- Felt√∂lt√©s / T√∂rl√©s -->
            <div class="action-group">
                <button class="action-btn" onclick="document.getElementById('file-input').click()">üìÅ Felt√∂lt√©s</button>
                <button class="action-btn" onclick="resetJewelry()">üóëÔ∏è T√∂rl√©s</button>
            </div>
        </div>
    </div>

    <input type="file" id="file-input" accept="image/png,image/jpeg,image/webp" onchange="handleFileSelect(event)">

    <script>
        // --- KONFIGUR√ÅCI√ì ---
        const CONFIG = {
            smoothing: 0.15,           // Sim√≠t√°s faktor (min√©l kisebb, ann√°l lassabb/sim√°bb)
            transitionStart: 30,       // Fok: ahol elkezd≈ëdik az √°tmenet
            transitionEnd: 45,         // Fok: ahol teljesen √°tv√°lt a vonalra
            baseScaleBracelet: 2.6,    // Kark√∂t≈ë alapm√©ret szorz√≥
            baseScaleRing: 1.1,        // Gy≈±r≈± alapm√©ret szorz√≥ (ujjhoz k√©pest)
        };

        // --- √ÅLLAPOT (STATE) ---
        let currentMode = 'bracelet'; // 'bracelet' vagy 'ring'
        let currentFingerIndex = 2;   // 0=mutat√≥, 1=k√∂z√©ps≈ë, 2=gy≈±r≈±s, 3=kisujj
        const fingerNames = ['Mutat√≥ujj', 'K√∂z√©ps≈ëujj', 'Gy≈±r≈±sujj', 'Kisujj'];
        const fingerLandmarks = [
            { tip: 8, base: 5 },   // Mutat√≥
            { tip: 12, base: 9 },  // K√∂z√©ps≈ë
            { tip: 16, base: 13 }, // Gy≈±r≈±s
            { tip: 20, base: 17 }  // Kisujj
        ];
        
        let currentCamera = 'environment'; // H√°tlapi kamera alapb√≥l
        let isMirrored = true;
        let hasJewelry = false;
        let isVideoReady = false;
        
        // Sim√≠tott √©rt√©kek (Lerp miatt)
        let state = {
            x: window.innerWidth / 2, y: window.innerHeight / 2,
            rotX: 0, rotY: 0, rotZ: 0,
            scale: 1,
            visibility: 0, // 0-1
            yaw: 0         // Abszol√∫t forgat√°si sz√∂g
        };

        let target = {
            x: window.innerWidth / 2, y: window.innerHeight / 2,
            rotX: 0, rotY: 0, rotZ: 0,
            scale: 1,
            visibility: 0,
            yaw: 0
        };

        // --- DOM ELEMEK ---
        const videoElement = document.getElementById('input_video');
        const wristAnchor = document.getElementById('wrist-anchor');
        const jewelryCard = document.getElementById('jewelry-card');
        const jewelryImg = document.getElementById('jewelry-img');
        const dashedLine = document.getElementById('dashed-line');
        const instructions = document.getElementById('instructions');
        const fingerControls = document.getElementById('finger-controls');
        const fingerLabel = document.getElementById('finger-label');
        const btnBracelet = document.getElementById('btn-bracelet');
        const btnRing = document.getElementById('btn-ring');

        // --- MEDIPIPE BE√ÅLL√çT√ÅS ---
        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});

        hands.setOptions({
            maxNumHands: 1,        // Csak 1 k√©z k√∂vet√©se a sebess√©g√©rt
            modelComplexity: 1,   // 1 = k√∂zepes pontoss√°g √©s sebess√©g
            minDetectionConfidence: 0.6,
            minTrackingConfidence: 0.6
        });

        hands.onResults(onResults);

        // --- INIT F√úGGV√âNYEK ---
        function initCamera() {
            document.getElementById('loading').style.display = 'block';
            if (window.camera) window.camera.stop();

            window.camera = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); },
                width: 1280, height: 720,
                facingMode: currentCamera
            });
            
            window.camera.start()
                .then(() => {
                    document.getElementById('loading').style.display = 'none';
                    isVideoReady = true;
                    updateMirror();
                })
                .catch(err => {
                    console.error(err);
                    alert('Kamera hiba! Enged√©lyezd a b√∂ng√©sz≈ëben.');
                });
        }

        function toggleMirror() { isMirrored = !isMirrored; updateMirror(); }
        function toggleCamera() { currentCamera = currentCamera === 'environment' ? 'user' : 'environment'; initCamera(); }
        function updateMirror() { videoElement.style.transform = isMirrored ? 'scaleX(-1)' : 'scaleX(1)'; }

        // --- UI LOGIKA ---
        function setMode(mode) {
            currentMode = mode;
            if (mode === 'bracelet') {
                btnBracelet.classList.add('active');
                btnRing.classList.remove('active');
                fingerControls.classList.remove('visible');
            } else {
                btnBracelet.classList.remove('active');
                btnRing.classList.add('active');
                fingerControls.classList.add('visible');
            }
            updateFingerLabel();
        }

        function nextFinger() { currentFingerIndex = (currentFingerIndex + 1) % 4; updateFingerLabel(); }
        function prevFinger() { currentFingerIndex = (currentFingerIndex - 1 + 4) % 4; updateFingerLabel(); }
        function updateFingerLabel() { fingerLabel.textContent = fingerNames[currentFingerIndex]; }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    jewelryImg.src = e.target.result;
                    jewelryImg.onload = () => {
                        hasJewelry = true;
                        jewelryImg.style.display = 'block';
                        instructions.style.display = 'none';
                        // K√©p ar√°nyainak meg≈ërz√©se
                        const aspect = jewelryImg.naturalHeight / jewelryImg.naturalWidth;
                        // Alap sz√©less√©g pixelben (ar√°nyos√≠tva)
                        const baseW = currentMode === 'bracelet' ? 300 : 120;
                        jewelryImg.style.width = baseW + 'px';
                        jewelryImg.style.height = (baseW * aspect) + 'px';
                    };
                };
                reader.readAsDataURL(file);
            }
        }

        function resetJewelry() {
            hasJewelry = false;
            jewelryImg.src = '';
            jewelryImg.style.display = 'none';
            instructions.style.display = 'block';
            state.visibility = 0; target.visibility = 0;
        }

        // --- MATEMATIKAI SEG√âDEK ---
        function lerp(start, end, factor) { return start + (end - start) * factor; }
        function clamp(val, min, max) { return Math.min(Math.max(val, min), max); }
        function distance(p1, p2) { return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2)); }
        function angle(p1, p2) { return Math.atan2(p2.y - p1.y, p2.x - p1.x); }

        // --- FELDOLGOZ√ì L√ìGICA (A "MOTOR") ---
        function onResults(results) {
            if (!hasJewelry || !isVideoReady) return;
            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                target.visibility = 0; target.yaw = 90;
                return;
            }

            const lm = results.multiHandLandmarks[0];
            let centerX, centerY, rotZ, yawDeg, scale, pitch;

            if (currentMode === 'bracelet') {
                // --- KARK√ñT≈ê LOGIKA ---
                const wrist = lm[0];
                const middle = lm[9];
                const index = lm[5];
                const pinky = lm[17];

                // 1. Poz√≠ci√≥ (Csukl√≥ √©s K√∂z√©ps≈ë ujj √°tlaga)
                let cx = (wrist.x + middle.x) / 2;
                let cy = (wrist.y + middle.y) / 2;
                if (isMirrored) cx = 1 - cx;
                centerX = cx * window.innerWidth;
                centerY = cy * window.innerHeight;

                // 2. Forgat√°s (Roll)
                let dx = middle.x - wrist.x;
                let dy = middle.y - wrist.y;
                rotZ = Math.atan2(dy, dx) * (180 / Math.PI) + 90;
                if (isMirrored) rotZ = -rotZ;

                // 3. Yaw (Oldalra fordul√°s) - Teny√©r ar√°ny√°b√≥l
                const w = distance(lm[5], lm[17]); // Teny√©r sz√©less√©ge
                const h = distance(lm[0], lm[9]);  // K√©z hossza
                const aspect = w / h; // Front√°lis: ~1.0, Oldal: ~0.3
                
                // Map aspect (-0.6) to angle (90)
                const yawFactor = clamp((aspect - 0.3) / 0.7, 0, 1); 
                yawDeg = (1 - yawFactor) * 90;
                if (isMirrored) yawDeg = -yawDeg; // Ir√°ny korrig√°l√°s

                // 4. Pitch (Fel-le d√∂nt√©s) - K√∂zvetlen becsl√©s
                pitch = (lm[9].y - lm[0].y) * 40; // K√∂z√©ps≈ë ujj magass√°g vs csukl√≥

                // 5. Sk√°la
                const refSize = w * window.innerWidth;
                scale = (refSize * CONFIG.baseScaleBracelet) / 300; // 300 az alap k√©p sz√©less√©ge

            } else {
                // --- GY≈∞R≈∞ LOGIKA ---
                const f = fingerLandmarks[currentFingerIndex];
                const tip = lm[f.tip];
                const base = lm[f.base];

                // 1. Poz√≠ci√≥ (Ujj als√≥ harmada)
                let cx = base.x * 0.8 + tip.x * 0.2; // Ink√°bb az alap k√∂zel√©be
                let cy = base.y * 0.8 + tip.y * 0.2;
                if (isMirrored) cx = 1 - cx;
                centerX = cx * window.innerWidth;
                centerY = cy * window.innerHeight;

                // 2. Forgat√°s (Roll)
                let dx = tip.x - base.x;
                let dy = tip.y - base.y;
                rotZ = Math.atan2(dy, dx) * (180 / Math.PI) + 90;
                if (isMirrored) rotZ = -rotZ;

                // 3. Yaw & Pitch (Egyszer≈±s√≠tve ujjakra)
                // A MediaPipe ujj orient√°ci√≥ja (Z koord) n√©ha zajos, ez√©rt geometriai becsl√©s
                const neighborIdx = currentFingerIndex === 3 ? 13 : currentFingerIndex + 1 === 4 ? 5 : fingerLandmarks[currentFingerIndex+1].base;
                const neighborBase = lm[neighborIdx];
                const sideW = distance(base, neighborBase);
                const fingerH = distance(base, tip);
                const aspect = sideW / fingerH;
                
                yawDeg = (1 - clamp(aspect / 0.5, 0, 1)) * 60; // Kisebb tartom√°ny ujjra
                if (isMirrored) yawDeg = -yawDeg;

                pitch = (tip.y - base.y) * 20;

                // 4. Sk√°la (Ujj sz√©less√©g)
                const fingerWidthPx = sideW * window.innerWidth;
                scale = (fingerWidthPx * CONFIG.baseScaleRing) / 120; // 120 az alap gy≈±r≈± sz√©less√©g
            }

            // Target √°llapot be√°ll√≠t√°sa
            target.x = centerX;
            target.y = centerY;
            target.rotZ = rotZ;
            target.rotY = yawDeg;
            target.rotX = pitch;
            target.scale = clamp(scale, 0.4, 3.0);
            target.yaw = Math.abs(yawDeg);

            // Visibility sz√°m√≠t√°s (30-45 √°tmenet)
            let vis = 1.0;
            if (target.yaw >= CONFIG.transitionEnd) vis = 0.0;
            else if (target.yaw >= CONFIG.transitionStart) {
                // Line√°ris cs√∂kken√©s 1.0 -> 0.0
                vis = 1.0 - ((target.yaw - CONFIG.transitionStart) / (CONFIG.transitionEnd - CONFIG.transitionStart));
            }
            target.visibility = vis;
        }

        // --- ANIM√ÅCI√ìS LOOP (RENDERER) ---
        function animate() {
            // 1. Sim√≠t√°s (Lerp)
            state.x = lerp(state.x, target.x, CONFIG.smoothing);
            state.y = lerp(state.y, target.y, CONFIG.smoothing);
            state.rotZ = lerp(state.rotZ, target.rotZ, CONFIG.smoothing);
            state.rotY = lerp(state.rotY, target.rotY, CONFIG.smoothing);
            state.rotX = lerp(state.rotX, target.rotX, CONFIG.smoothing);
            state.scale = lerp(state.scale, target.scale, CONFIG.smoothing);
            state.visibility = lerp(state.visibility, target.visibility, CONFIG.smoothing);
            state.yaw = lerp(state.yaw, target.yaw, CONFIG.smoothing);

            if (!hasJewelry) { requestAnimationFrame(animate); return; }

            // 2. √Åtmeneti Z√≥na Logika (Cross-Fade 30-45)
            let jewelryOpacity = 1.0;
            let lineOpacity = 0.0;
            let lineScale = 1.0;

            if (state.yaw <= CONFIG.transitionStart) {
                // Z√≥na 0-30¬∞: Csak √©kszer
                jewelryOpacity = 1.0;
                lineOpacity = 0.0;
            } else if (state.yaw >= CONFIG.transitionEnd) {
                // Z√≥na 45¬∞+: Csak vonal
                jewelryOpacity = 0.0;
                lineOpacity = 1.0;
            } else {
                // Z√≥na 30-45¬∞: √Åtmenet
                const t = (state.yaw - CONFIG.transitionStart) / (CONFIG.transitionEnd - CONFIG.transitionStart);
                jewelryOpacity = 1.0 - t; // √âkszer elhalv√°nyul
                lineOpacity = t;          // Vonal megjelenik
                lineScale = 1.0 + (t * 0.2); // Vonal kicsit "k√∂zelebb" j√∂n
            }

            // Ha a forgat√°s t√∫l nagy (>85), h√°tul van a k√©z -> √©kszer teljesen rejtve (backface)
            if (Math.abs(state.rotY) > 85) jewelryOpacity = 0;

            // 3. St√≠lusok alkalmaz√°sa
            wristAnchor.style.transform = `translate3d(${state.x}px, ${state.y}px, 0)`;
            
            jewelryCard.style.transform = `
                rotateY(${state.rotY}deg) 
                rotateX(${-state.rotX}deg) 
                rotateZ(${state.rotZ}deg) 
                scale(${state.scale})
            `;
            jewelryCard.style.opacity = jewelryOpacity;

            // 4. Szaggatott vonal kezel√©se
            if (lineOpacity > 0.01) {
                dashedLine.style.display = 'block';
                dashedLine.style.left = state.x + 'px';
                dashedLine.style.top = state.y + 'px';
                dashedLine.style.opacity = lineOpacity;
                
                // Vonal m√©retez√©se m√≥d f√ºgg≈ë
                const baseSize = currentMode === 'bracelet' ? 100 : 50;
                const size = baseSize * lineScale;
                dashedLine.style.width = size + 'px';
                dashedLine.style.height = size + 'px';
            } else {
                dashedLine.style.display = 'none';
            }

            requestAnimationFrame(animate);
        }

        // --- IND√çT√ÅS ---
        initCamera();
        animate();
    </script>
</body>
</html>
