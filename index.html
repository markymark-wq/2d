<!-- 
  CosmicAR - 2D Bracelet VTO (Fixed with Google Edge / World Landmarks Logic)
  
  V√ÅLTOZTAT√ÅSOK AZ EREDETIHEZ K√âPESZT:
  - A "onResults" matematikai r√©sze teljesen √°t√≠rva.
  - Mostant√≥l "multiHandWorldLandmarks" (3D koordin√°t√°k) alapj√°n sz√°molunk.
  - Ez jav√≠tja a "t√∫lre fordul√°sb√≥l val√≥ √∫sz√°st" √©s a sk√°l√°z√°st.
-->
<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CosmicAR - 2D VTO</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* --- CONTAINER (Mobile Mode Force) --- */
        #app-container {
            width: 100%;
            height: 100%;
            max-width: 480px; /* Max telefon sz√©less√©g */
            margin: 0 auto;
            position: relative;
            background: #000;
            overflow: hidden;
        }

        /* Desktop centerel√©s */
        @media (min-width: 481px) {
            body {
                background: #1a1a1a;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            #app-container {
                height: 90vh;
                aspect-ratio: 9/16;
                border-radius: 24px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            }
        }

        /* --- VIDEO LAYER --- */
        #video-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
            object-fit: cover;
        }
        
        #input_video {
            width: 100%; height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* T√ºk√∂r */
        }

        /* --- AR LAYER (3D Context) --- */
        #ar-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10;
            pointer-events: none;
            perspective: 1200px; /* M√©lys√©g √©rz√©kel√©s */
        }

        /* 
           WRIST ANCHOR 
           Ez az elem mozog a csukl√≥val.
        */
        #wrist-anchor {
            position: absolute;
            top: 50%; left: 50%;
            width: 0; height: 0;
            transform-style: preserve-3d;
            will-change: transform;
        }

        /* KARK√ñT√ñ CONTAINER */
        #jewelry-wrapper {
            position: absolute;
            left: 0; top: 0;
            transform-style: preserve-3d;
            transform: translateZ(0px); 
        }

        #jewelry-img {
            display: block;
            transform: translate(-50%, -50%);
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.35));
            max-width: none;
            pointer-events: none;
        }

        /* 
           DASHED ARC 
           Vastag√≠t√°s: 10px-re n√∂velve
        */
        #dashed-arc {
            position: absolute;
            left: 0; top: 0;
            transform: translate(-50%, -50%) rotateX(-75deg);
            border-radius: 50%;
            border: 10px dashed rgba(255, 255, 255, 0.8); /* Itt n√∂velt√ºk vastagabbra */
            pointer-events: none;
            opacity: 0; 
            /* Kis h√°tra tol√°s Z-ben, hogy ne l√≥gjon ki el≈ëre */
            transform: translate(-50%, -50%) translateZ(-20px) rotateX(-75deg);
        }

        @keyframes dash-spin {
            from { border-color: rgba(255,255,255,0.4); }
            50% { border-color: rgba(255,255,255,0.9); }
            to { border-color: rgba(255,255,255,0.4); }
        }
        #dashed-arc.active {
            animation: dash-spin 2s infinite ease-in-out;
        }

        /* --- UI LAYER --- */
        #ui-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 100;
            pointer-events: none;
        }

        #instruction-text {
            position: absolute;
            top: 15%; left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white; 
            padding: 10px 18px; 
            border-radius: 20px;
            font-size: 13px; 
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            white-space: nowrap;
        }

        .btn {
            pointer-events: auto;
            background: rgba(30,30,30,0.8);
            backdrop-filter: blur(12px);
            color: white; 
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 16px;
            font-weight: 600; 
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }
        .btn:active { transform: scale(0.95); background: rgba(50,50,50,0.9); }

        .top-controls {
            position: absolute; 
            top: 10px; left: 0; 
            width: 100%;
            display: flex; 
            justify-content: space-between; 
            padding: 0 12px;
        }
        
        .icon-btn { padding: 8px 12px; }

        .bottom-controls {
            position: absolute; 
            bottom: 20px; left: 50%;
            transform: translateX(-50%);
            width: 92%;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: auto;
        }

        .mode-selector {
            display: flex; 
            gap: 6px;
            background: rgba(30,30,30,0.85); 
            padding: 4px; 
            border-radius: 20px;
            backdrop-filter: blur(12px);
        }
        
        .mode-btn {
            flex: 1; 
            background: transparent; 
            color: rgba(255,255,255,0.6);
            border: none; 
            padding: 10px; 
            border-radius: 16px; 
            font-size: 13px;
            cursor: pointer; 
            transition: all 0.2s;
            font-weight: 600;
        }
        
        .mode-btn.active {
            background: #fff; 
            color: #000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .finger-controls {
            display: none; 
            gap: 10px;
            background: rgba(30,30,30,0.85); 
            padding: 6px 14px; 
            border-radius: 20px;
            align-items: center; 
            justify-content: center;
            backdrop-filter: blur(12px);
        }
        
        .finger-controls.visible { display: flex; }
        
        .finger-btn {
            background: rgba(255,255,255,0.15); 
            color: white;
            border: none; 
            width: 32px; height: 32px; 
            border-radius: 50%;
            font-size: 14px; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .finger-label {
            color: white; 
            font-size: 13px; 
            font-weight: 600;
            min-width: 90px; 
            text-align: center;
        }

        .loading {
            position: fixed; 
            top: 50%; left: 50%;
            transform: translate(-50%, -50%); 
            color: white; 
            z-index: 1000;
            background: rgba(0,0,0,0.9); 
            padding: 20px 30px; 
            border-radius: 16px;
            font-size: 14px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>

    <div id="app-container">
        <div class="loading" id="loading">Kamera inicializ√°l√°sa...</div>

        <!-- Video Layer -->
        <div id="video-layer">
            <video id="input_video" playsinline></video>
        </div>

        <!-- AR Layer -->
        <div id="ar-layer">
            <!-- Wrist Anchor: A teljes k√©z rendszer k√∂z√©ppontja -->
            <div id="wrist-anchor">
                
                <!-- Kark√∂t≈ë: A b≈ër√∂n fekszik -->
                <div id="jewelry-wrapper">
                    <img id="jewelry-img" src="" alt="jewelry" style="display:none;">
                </div>

                <!-- Dashed Arc: A csukl√≥ k√∂r√ºl √°ll -->
                <div id="dashed-arc"></div>
            </div>
        </div>

        <!-- UI Layer -->
        <div id="ui-layer">
            <div class="top-controls">
                <button class="btn icon-btn" onclick="toggleMirror()">üîÑ T√ºk√∂r</button>
                <button class="btn icon-btn" onclick="toggleCamera()">üì∑ Kamera</button>
            </div>

            <div id="instruction-text">Tartsd a csukl√≥dat a kamera fel√©</div>
            
            <div class="bottom-controls">
                <div class="mode-selector">
                    <button class="mode-btn active" id="btn-bracelet" onclick="setMode('bracelet')">üìø Kark√∂t≈ë</button>
                    <button class="mode-btn" id="btn-ring" onclick="setMode('ring')">üíç Gy≈±r≈±</button>
                </div>
                
                <div class="finger-controls" id="finger-controls">
                    <button class="finger-btn" onclick="prevFinger()">‚óÄ</button>
                    <div class="finger-label" id="finger-label">Gy≈±r≈±sujj</div>
                    <button class="finger-btn" onclick="nextFinger()">‚ñ∂</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- KONFIGUR√ÅCI√ì ---
        const CONFIG = {
            assetsPath: './assets/',       // Kisbet≈±s mappa!
            smoothing: 0.12,        
            transitionStart: 20,           // 20 fokn√°l kezd≈ëdik az √°tmenet
            transitionEnd: 45,             // 45 fokn√°l teljes az √°tmenet
            baseScaleBracelet: 1.6, 
            baseScaleRing: 1.0,     
            maxRotationY: 60,
            worldScaleFactor: 80 // Konverzi√≥s faktor a m√©teres adatokhoz
        };

        // --- √ÅLLAPOT ---
        let currentMode = 'bracelet';
        let currentFingerIndex = 2;
        const fingerNames = ['Mutat√≥ujj', 'K√∂z√©ps≈ëujj', 'Gy≈±r≈±sujj', 'Kisujj'];
        const fingerLandmarks = [
            { tip: 8, mcp: 5 },   
            { tip: 12, mcp: 9 },  
            { tip: 16, mcp: 13 }, 
            { tip: 20, mcp: 17 }  
        ];
        
        let currentCamera = 'environment';
        let isMirrored = true;
        let isVideoReady = false;
        
        // Anim√°ci√≥s √°llapot
        let state = {
            x: 0.5, y: 0.5,
            rotationZ: 0,        
            rotationY: 0,        
            scale: 1,
            arcOpacity: 0,
            visibility: 1,
            wristWidth: 0.1      
        };
        
        let target = {
            x: 0.5, y: 0.5,
            rotationZ: 0,
            rotationY: 0,
            scale: 1,
            arcOpacity: 0,
            visibility: 1,
            wristWidth: 0.1
        };

        // --- DOM REFERENCI√ÅK ---
        const videoElement = document.getElementById('input_video');
        const wristAnchor = document.getElementById('wrist-anchor');
        const jewelryWrapper = document.getElementById('jewelry-wrapper');
        const jewelryImg = document.getElementById('jewelry-img');
        const dashedArc = document.getElementById('dashed-arc');
        const instructions = document.getElementById('instruction-text');
        const fingerControls = document.getElementById('finger-controls');
        const fingerLabel = document.getElementById('finger-label');
        const btnBracelet = document.getElementById('btn-bracelet');
        const btnRing = document.getElementById('btn-ring');
        const appContainer = document.getElementById('app-container');

        // --- ASSET BET√ñLT√âS ---
        function loadAsset(type) {
            const img = new Image();
            const src = type === 'bracelet' 
                ? CONFIG.assetsPath + 'bracelet.png' 
                : CONFIG.assetsPath + 'ring.png';
            
            img.onload = () => {
                jewelryImg.src = src;
                jewelryImg.style.display = 'block';
                
                const aspect = img.naturalHeight / img.naturalWidth;
                const baseW = type === 'bracelet' ? 240 : 80; 
                jewelryImg.style.width = baseW + 'px';
                jewelryImg.style.height = (baseW * aspect) + 'px';
            };
            
            img.onerror = () => {
                console.error("Hiba:", src);
                instructions.textContent = "Hiba: K√©p nem tal√°lhat√≥ (Ellen≈ërizd az 'assets' mapp√°t)";
            };
            
            img.src = src;
        }

        // --- MEDIAPIP BE√ÅLL√çT√ÅS ---
        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onResults);

        // --- KAMERA ---
        function initCamera() {
            document.getElementById('loading').style.display = 'block';
            
            if (window.camera) {
                try { window.camera.stop(); } catch(e){}
            }

            window.camera = new Camera(videoElement, {
                onFrame: async () => await hands.send({image: videoElement}),
                width: 1280, 
                height: 720,
                facingMode: currentCamera
            });
            
            window.camera.start()
                .then(() => {
                    document.getElementById('loading').style.display = 'none';
                    isVideoReady = true;
                    updateMirror();
                    loadAsset(currentMode);
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('loading').textContent = "Kamera hiba! Enged√©lyezd a hozz√°f√©r√©st.";
                });
        }

        function toggleMirror() { 
            isMirrored = !isMirrored; 
            updateMirror(); 
        }
        
        function toggleCamera() { 
            currentCamera = currentCamera === 'environment' ? 'user' : 'environment'; 
            initCamera(); 
        }
        
        function updateMirror() { 
            videoElement.style.transform = isMirrored ? 'scaleX(-1)' : 'scaleX(1)'; 
        }

        // --- UI ---
        function setMode(mode) {
            currentMode = mode;
            loadAsset(mode);
            
            if (mode === 'bracelet') {
                btnBracelet.classList.add('active');
                btnRing.classList.remove('active');
                fingerControls.classList.remove('visible');
                instructions.textContent = "Tartsd a csukl√≥dat a kamera fel√©";
            } else {
                btnBracelet.classList.remove('active');
                btnRing.classList.add('active');
                fingerControls.classList.add('visible');
                updateFingerLabel();
            }
            state.arcOpacity = 0;
            target.arcOpacity = 0;
        }

        function nextFinger() { 
            currentFingerIndex = (currentFingerIndex + 1) % 4; 
            updateFingerLabel(); 
        }
        
        function prevFinger() { 
            currentFingerIndex = (currentFingerIndex - 1 + 4) % 4; 
            updateFingerLabel(); 
        }
        
        function updateFingerLabel() { 
            fingerLabel.textContent = fingerNames[currentFingerIndex];
            instructions.textContent = "Ny√∫jtsd ki a " + fingerNames[currentFingerIndex].toLowerCase() + "-t";
        }

        // --- MATEMATIKA ---
        function lerp(start, end, factor) { 
            return start + (end - start) * factor; 
        }
        
        function clamp(val, min, max) { 
            return Math.min(Math.max(val, min), max); 
        }
        
        function dist(p1, p2) { 
            return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2)); 
        }

        // --- MAIN LOGIC (M√ìDOS√çTOTT VERZI√ì) ---
        function onResults(results) {
            if (!isVideoReady) return;
            
            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                target.visibility = 0;
                target.arcOpacity = 0;
                return;
            }

            const lm = results.multiHandLandmarks[0];
            const worldLm = results.multiHandWorldLandmarks[0];
            
            const screenW = appContainer.offsetWidth;
            const screenH = appContainer.offsetHeight;

            let centerX, centerY, rotZ, yawDeg, scale, wristWidthPx;

            if (currentMode === 'bracelet') {
                const w = worldLm[0];  // Wrist
                const m = worldLm[9];  // Middle MCP
                const i = worldLm[5];  // Index MCP
                const p = worldLm[17]; // Pinky MCP

                // 1. POZ√çCI√ì - CSAK a csukl√≥ (0. landmark)
                centerX = lm[0].x;
                centerY = lm[0].y;

                // 2. CSUKL√ì SZ√âLESS√âG (5-√∂s √©s 17-es t√°vols√°ga K√âPERNY≈êN)
                const indexScreen = lm[5];
                const pinkyScreen = lm[17];
                wristWidthPx = Math.sqrt(
                    Math.pow((indexScreen.x - pinkyScreen.x) * screenW, 2) +
                    Math.pow((indexScreen.y - pinkyScreen.y) * screenH, 2)
                );

                // 3. FORGAT√ÅS Z (ROLL)
                const dx = m.x - w.x;
                const dy = m.y - w.y;
                let angle = Math.atan2(dy, dx) * (180 / Math.PI) + 90;
                
                if (angle - state.rotationZ > 180) angle -= 360;
                if (angle - state.rotationZ < -180) angle += 360;
                
                rotZ = isMirrored ? -angle : angle;

                // 4. YAW (Oldalra fordul√°s)
                const zDiff = w.z - m.z;
                const xDiff = m.x - w.x;
                yawDeg = Math.atan2(xDiff, Math.abs(zDiff)) * (180 / Math.PI);
                if (isMirrored) yawDeg = -yawDeg;

                target.isPalmFacingUp = zDiff > 0.02;
                
                // SK√ÅLA - a csukl√≥ sz√©less√©g√©hez igaz√≠tva
                scale = wristWidthPx / 120; // 120px az alap kark√∂t≈ë sz√©less√©g

            } else {
                // GY≈∞R≈∞ M√ìD
                const w = worldLm[0];
                const tip = worldLm[fingerLandmarks[currentFingerIndex].tip];
                const mcp = worldLm[fingerLandmarks[currentFingerIndex].mcp];

                centerX = (lm[fingerLandmarks[currentFingerIndex].mcp].x + lm[fingerLandmarks[currentFingerIndex].tip].x) / 2;
                centerY = (lm[fingerLandmarks[currentFingerIndex].mcp].y + lm[fingerLandmarks[currentFingerIndex].tip].y) / 2;

                const dx = tip.x - mcp.x;
                const dy = tip.y - mcp.y;
                let angle = Math.atan2(dy, dx) * (180 / Math.PI) + 90;
                
                if (angle - state.rotationZ > 180) angle -= 360;
                if (angle - state.rotationZ < -180) angle += 360;

                rotZ = isMirrored ? -angle : angle;
                yawDeg = 0;
                target.isPalmFacingUp = false;

                const len = Math.sqrt(Math.pow(tip.x - mcp.x, 2) + Math.pow(tip.y - mcp.y, 2) + Math.pow(tip.z - mcp.z, 2));
                scale = len * CONFIG.worldScaleFactor * 4;
                wristWidthPx = 0;
            }

            if (isMirrored) centerX = 1 - centerX;

            target.x = centerX;
            target.y = centerY;
            target.rotationZ = rotZ;
            target.rotationY = clamp(yawDeg, -CONFIG.maxRotationY, CONFIG.maxRotationY);
            target.scale = clamp(scale, 0.5, 3.5);
            target.wristWidth = wristWidthPx;

            // √ÅTT≈∞N√âSI LOGIKA
            if (currentMode === 'bracelet') {
                if (!target.isPalmFacingUp) {
                    target.visibility = 1;
                    target.arcOpacity = 0;
                } else {
                    target.visibility = 0;
                    target.arcOpacity = 1;
                }
            } else {
                target.visibility = 1;
                target.arcOpacity = 0;
            }
        }

        // --- RENDER LOOP (M√ìDOS√çTOTT VERZI√ì) ---
        function animate() {
            const screenW = appContainer.offsetWidth;
            const screenH = appContainer.offsetHeight;

            state.x = lerp(state.x, target.x, CONFIG.smoothing);
            state.y = lerp(state.y, target.y, CONFIG.smoothing);
            state.rotationZ = lerp(state.rotationZ, target.rotationZ, CONFIG.smoothing);
            state.rotationY = lerp(state.rotationY, target.rotationY, CONFIG.smoothing);
            state.scale = lerp(state.scale, target.scale, CONFIG.smoothing);
            state.arcOpacity = lerp(state.arcOpacity, target.arcOpacity, 0.1);
            state.visibility = lerp(state.visibility, target.visibility, CONFIG.smoothing);
            state.wristWidth = lerp(state.wristWidth, target.wristWidth, 0.1);

            const pixelX = state.x * screenW;
            const pixelY = state.y * screenH;

            // 1. Wrist Anchor (csak poz√≠ci√≥ √©s Z forgat√°s)
            wristAnchor.style.left = pixelX + 'px';
            wristAnchor.style.top = pixelY + 'px';
            wristAnchor.style.transform = `rotateZ(${state.rotationZ}deg)`;

            // 2. KARK√ñT≈ê - a csukl√≥ sz√©less√©g√©hez igaz√≠tott m√©ret
            jewelryWrapper.style.opacity = state.visibility;
            jewelryWrapper.style.transform = `rotateY(${state.rotationY}deg) scale(${state.scale})`;

            // 3. DASHED ARC - PONTOSAN a csukl√≥ sz√©less√©ge
            const arcSize = state.wristWidth * 1.2; // 20%-kal nagyobb, mint a csukl√≥
            
            dashedArc.style.width = arcSize + 'px';
            dashedArc.style.height = arcSize + 'px';
            dashedArc.style.opacity = state.arcOpacity;
            
            dashedArc.style.transform = `
                translate(-50%, -50%) 
                rotateY(${state.rotationY}deg) 
                rotateX(-75deg)
            `;

            if (state.arcOpacity > 0.1) {
                dashedArc.classList.add('active');
            } else {
                dashedArc.classList.remove('active');
            }

            requestAnimationFrame(animate);
        }

        // --- INIT ---
        initCamera();
        setMode('bracelet');
        animate();
    </script>
</body>
</html>
