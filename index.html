<!-- CosmicAR - 2D Bracelet VTO -->
<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CosmicAR - 2D VTO</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }

        #app-container { width: 100%; height: 100%; max-width: 480px; margin: 0 auto; position: relative; background: #000; overflow: hidden; }

        @media (min-width: 481px) {
            body { background: #1a1a1a; display: flex; align-items: center; justify-content: center; }
            #app-container { height: 90vh; aspect-ratio: 9/16; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        }

        #video-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #input_video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        #ar-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; perspective: 1200px; transform-style: preserve-3d; }

        #wrist-anchor { position: absolute; left: 50%; top: 50%; width: 0; height: 0; transform-style: preserve-3d; }

        #jewelry-wrapper { position: absolute; left: 0; top: 0; transform-style: preserve-3d; opacity: 1; }

        #jewelry-img { display: block; transform: translate(-50%, -50%); filter: drop-shadow(0 6px 12px rgba(0,0,0,0.3)); max-width: none; max-height: none; }

        #dashed-arc { 
            position: absolute; left: 0; top: 0; 
            border-radius: 50%; border: 3px dashed rgba(255, 255, 255, 0.9); 
            opacity: 0; pointer-events: none; transform-style: preserve-3d;
            /* Csak a border l√°tszik, nincs box-shadow! */
        }

        @keyframes dash-spin {
            from { transform: rotateX(-60deg) rotate(0deg); }
            to { transform: rotateX(-60deg) rotate(360deg); }
        }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; pointer-events: none; }
        #instruction-text { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); color: white; padding: 12px 20px; border-radius: 20px; font-size: 14px; text-align: center; backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.15); white-space: nowrap; }
        .btn { pointer-events: auto; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; font-weight: 600; cursor: pointer; transition: transform 0.1s; }
        .btn:active { transform: scale(0.95); }
        .top-controls { position: absolute; top: 12px; left: 0; width: 100%; display: flex; justify-content: space-between; padding: 0 16px; }
        .icon-btn { padding: 8px 14px; font-size: 12px; }
        .bottom-controls { position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%); width: 90%; display: flex; flex-direction: column; gap: 10px; pointer-events: auto; }
        .mode-selector { display: flex; gap: 8px; background: rgba(0,0,0,0.7); padding: 6px; border-radius: 24px; backdrop-filter: blur(10px); }
        .mode-btn { flex: 1; background: transparent; color: rgba(255,255,255,0.7); border: none; padding: 12px; border-radius: 18px; font-size: 14px; cursor: pointer; transition: all 0.25s; font-weight: 600; }
        .mode-btn.active { background: rgba(255,255,255,0.95); color: #000; }
        .finger-controls { display: none; gap: 12px; background: rgba(0,0,0,0.7); padding: 8px 16px; border-radius: 24px; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .finger-controls.visible { display: flex; }
        .finger-btn { background: rgba(255,255,255,0.2); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .finger-label { color: white; font-size: 14px; font-weight: 600; min-width: 100px; text-align: center; }
        .loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; z-index: 1000; background: rgba(0,0,0,0.85); padding: 24px 32px; border-radius: 16px; font-size: 14px; text-align: center; }
    </style>
</head>
<body>

    <div id="app-container">
        <div class="loading" id="loading">Kamera bet√∂lt√©se...</div>

        <div id="video-layer">
            <video id="input_video" playsinline></video>
        </div>

        <div id="ar-layer">
            <div id="wrist-anchor">
                <div id="jewelry-wrapper">
                    <img id="jewelry-img" src="" alt="jewelry" style="display:none;">
                </div>
                <div id="dashed-arc"></div>
            </div>
        </div>

        <div id="ui-layer">
            <div class="top-controls">
                <button class="btn icon-btn" onclick="toggleMirror()">üîÑ T√ºk√∂r</button>
                <button class="btn icon-btn" onclick="toggleCamera()">üì∑ Kamera</button>
            </div>

            <div id="instruction-text">Tartsd a csukl√≥dat a kamera fel√©</div>
            
            <div class="bottom-controls">
                <div class="mode-selector">
                    <button class="mode-btn active" id="btn-bracelet" onclick="setMode('bracelet')">üìø Kark√∂t≈ë</button>
                    <button class="mode-btn" id="btn-ring" onclick="setMode('ring')">üíç Gy≈±r≈±</button>
                </div>
                
                <div class="finger-controls" id="finger-controls">
                    <button class="finger-btn" onclick="prevFinger()">‚óÄ</button>
                    <div class="finger-label" id="finger-label">Gy≈±r≈±sujj</div>
                    <button class="finger-btn" onclick="nextFinger()">‚ñ∂</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            assetsPath: './Assets/',
            smoothing: 0.12,
            transitionStart: 25,
            transitionEnd: 50,
            baseScaleBracelet: 1.4,  // Kisebb alapm√©ret
            baseScaleRing: 1.0,
            circleTiltX: -60         // Kisebb d≈ël√©s
        };

        let currentMode = 'bracelet';
        let currentFingerIndex = 2;
        const fingerNames = ['Mutat√≥ujj', 'K√∂z√©ps≈ëujj', 'Gy≈±r≈±sujj', 'Kisujj'];
        const fingerLandmarks = [{ tip: 8, mcp: 5 }, { tip: 12, mcp: 9 }, { tip: 16, mcp: 13 }, { tip: 20, mcp: 17 }];
        
        let currentCamera = 'environment';
        let isMirrored = true;
        let isVideoReady = false;
        
        // State √©s target inicializ√°l√°sa
        let state = { x: 0.5, y: 0.5, rotZ: 0, rotY: 0, scale: 1, arcOpacity: 0, jewelryOpacity: 1, wristWidth: 100 };
        let target = { ...state };
        
        // El≈ëz≈ë sz√∂g a 360-as ugr√°s elker√ºl√©s√©re
        let prevRotZ = 0;
        let rotZOffset = 0;

        const videoElement = document.getElementById('input_video');
        const wristAnchor = document.getElementById('wrist-anchor');
        const jewelryWrapper = document.getElementById('jewelry-wrapper');
        const jewelryImg = document.getElementById('jewelry-img');
        const dashedArc = document.getElementById('dashed-arc');
        const instructions = document.getElementById('instruction-text');
        const fingerControls = document.getElementById('finger-controls');
        const fingerLabel = document.getElementById('finger-label');
        const btnBracelet = document.getElementById('btn-bracelet');
        const btnRing = document.getElementById('btn-ring');
        const appContainer = document.getElementById('app-container');

        function loadAsset(type) {
            const img = new Image();
            const src = type === 'bracelet' ? CONFIG.assetsPath + 'bracelet.png' : CONFIG.assetsPath + 'ring.png';
            
            img.onload = () => {
                jewelryImg.src = src;
                jewelryImg.style.display = 'block';
                const aspect = img.naturalHeight / img.naturalWidth;
                const baseW = type === 'bracelet' ? 220 : 80;
                jewelryImg.style.width = baseW + 'px';
                jewelryImg.style.height = (baseW * aspect) + 'px';
                console.log('Asset bet√∂ltve:', src);
            };
            img.onerror = () => console.error('Asset hiba:', src);
            img.src = src;
        }

        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        hands.onResults(onResults);

        function initCamera() {
            document.getElementById('loading').style.display = 'block';
            if (window.camera) window.camera.stop();

            window.camera = new Camera(videoElement, {
                onFrame: async () => await hands.send({image: videoElement}),
                width: 1280, height: 720, facingMode: currentCamera
            });
            
            window.camera.start()
                .then(() => {
                    document.getElementById('loading').style.display = 'none';
                    isVideoReady = true;
                    updateMirror();
                    loadAsset(currentMode);
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('loading').textContent = "Kamera hiba!";
                });
        }

        function toggleMirror() { isMirrored = !isMirrored; updateMirror(); }
        function toggleCamera() { currentCamera = currentCamera === 'environment' ? 'user' : 'environment'; initCamera(); }
        function updateMirror() { videoElement.style.transform = isMirrored ? 'scaleX(-1)' : 'scaleX(1)'; }

        function setMode(mode) {
            currentMode = mode;
            loadAsset(mode);
            if (mode === 'bracelet') {
                btnBracelet.classList.add('active'); btnRing.classList.remove('active');
                fingerControls.classList.remove('visible');
                instructions.textContent = "Tartsd a csukl√≥dat a kamera fel√©";
            } else {
                btnBracelet.classList.remove('active'); btnRing.classList.add('active');
                fingerControls.classList.add('visible'); updateFingerLabel();
            }
        }

        function nextFinger() { currentFingerIndex = (currentFingerIndex + 1) % 4; updateFingerLabel(); }
        function prevFinger() { currentFingerIndex = (currentFingerIndex - 1 + 4) % 4; updateFingerLabel(); }
        function updateFingerLabel() { fingerLabel.textContent = fingerNames[currentFingerIndex]; instructions.textContent = "Ny√∫jtsd ki a " + fingerNames[currentFingerIndex].toLowerCase() + "-t"; }

        function lerp(s, e, f) { return s + (e - s) * f; }
        function clamp(v, min, max) { return Math.min(Math.max(v, min), max); }
        function dist(p1, p2) { return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2)); }

        // Sz√∂g normaliz√°l√°s -180 √©s 180 k√∂z√©
        function normalizeAngle(angle) {
            while (angle > 180) angle -= 360;
            while (angle < -180) angle += 360;
            return angle;
        }

        function onResults(results) {
            if (!isVideoReady) return;
            
            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                target.jewelryOpacity = 0;
                target.arcOpacity = 0;
                return;
            }

            const lm = results.multiHandLandmarks[0];
            const screenW = appContainer.offsetWidth;

            let centerX, centerY, rotZ, rotY, wristW;

            if (currentMode === 'bracelet') {
                const wrist = lm[0];
                const midBase = lm[9];
                const indexBase = lm[5];
                const pinkyBase = lm[17];

                // POZ√çCI√ì: Csukl√≥ pont
                centerX = wrist.x;
                centerY = wrist.y + 0.02; // Kicsit lejjebb

                // CSUKL√ì SZ√âLESS√âG - ez adja a k√∂r m√©ret√©t!
                wristW = dist(indexBase, pinkyBase) * screenW;

                // Z FORGAT√ÅS: K√©z d≈ël√©se
                const dx = midBase.x - wrist.x;
                const dy = midBase.y - wrist.y;
                let rawAngle = Math.atan2(dy, dx) * (180 / Math.PI) + 90;
                
                // 360-as ugr√°s elker√ºl√©se
                rawAngle = normalizeAngle(rawAngle);
                if (isMirrored) rawAngle = -rawAngle;
                
                // Ha nagy az ugr√°s az el≈ëz≈ëh√∂z k√©pest, adjunk hozz√°/vonjunk ki 360-at
                let diff = rawAngle - (prevRotZ - rotZOffset);
                if (diff > 180) rotZOffset -= 360;
                else if (diff < -180) rotZOffset += 360;
                
                rotZ = rawAngle + rotZOffset;
                prevRotZ = rotZ;

                // Y FORGAT√ÅS: Oldalra fordul√°s
                const handW = dist(indexBase, pinkyBase);
                const handH = dist(wrist, midBase);
                const aspect = handW / (handH || 0.001);
                
                const yawFactor = clamp((aspect - 0.3) / 0.7, 0, 1);
                rotY = (1 - yawFactor) * 90;
                if (isMirrored) rotY = -rotY;
                if (indexBase.x > pinkyBase.x) rotY = -rotY;

            } else {
                const f = fingerLandmarks[currentFingerIndex];
                const tip = lm[f.tip]; const mcp = lm[f.mcp];
                
                centerX = (mcp.x + tip.x) / 2;
                centerY = (mcp.y + tip.y) / 2;
                
                const dx = tip.x - mcp.x;
                const dy = tip.y - mcp.y;
                let rawAngle = Math.atan2(dy, dx) * (180 / Math.PI) + 90;
                rawAngle = normalizeAngle(rawAngle);
                if (isMirrored) rawAngle = -rawAngle;
                
                let diff = rawAngle - (prevRotZ - rotZOffset);
                if (diff > 180) rotZOffset -= 360;
                else if (diff < -180) rotZOffset += 360;
                
                rotZ = rawAngle + rotZOffset;
                prevRotZ = rotZ;
                
                rotY = 0;
                wristW = 60; // Default gy≈±r≈± eset√©n
            }

            if (isMirrored) centerX = 1 - centerX;

            target.x = centerX;
            target.y = centerY;
            target.rotZ = rotZ;
            target.rotY = rotY;
            target.wristWidth = wristW;

            // √ÅTT≈∞N√âSI LOGIKA
            const absYaw = Math.abs(rotY);
            
            if (absYaw < CONFIG.transitionStart) {
                target.jewelryOpacity = 1;
                target.arcOpacity = 0;
            } else if (absYaw > CONFIG.transitionEnd) {
                target.jewelryOpacity = 0;
                target.arcOpacity = 1;
            } else {
                const t = (absYaw - CONFIG.transitionStart) / (CONFIG.transitionEnd - CONFIG.transitionStart);
                target.jewelryOpacity = 1 - t;
                target.arcOpacity = t;
            }
        }

        function animate() {
            const screenW = appContainer.offsetWidth;
            const screenH = appContainer.offsetHeight;

            // Sim√≠t√°s
            state.x = lerp(state.x, target.x, CONFIG.smoothing);
            state.y = lerp(state.y, target.y, CONFIG.smoothing);
            state.rotZ = lerp(state.rotZ, target.rotZ, CONFIG.smoothing);
            state.rotY = lerp(state.rotY, target.rotY, CONFIG.smoothing);
            state.wristWidth = lerp(state.wristWidth, target.wristWidth, CONFIG.smoothing);
            state.arcOpacity = lerp(state.arcOpacity, target.arcOpacity, 0.08);
            state.jewelryOpacity = lerp(state.jewelryOpacity, target.jewelryOpacity, CONFIG.smoothing);

            const px = state.x * screenW;
            const py = state.y * screenH;

            wristAnchor.style.left = px + 'px';
            wristAnchor.style.top = py + 'px';

            // KARK√ñT≈ê
            jewelryWrapper.style.opacity = state.jewelryOpacity;
            jewelryWrapper.style.transform = `
                rotateX(${CONFIG.circleTiltX}deg)
                rotateZ(${state.rotZ}deg)
                rotateY(${state.rotY * 0.3}deg)
            `;

            // DASHED ARC - A CSUKL√ì SZ√âLESS√âG√âHEZ IGAZ√çTVA
            // A csukl√≥ sz√©less√©g√©nek 2.2-szerese (kicsit nagyobb, hogy k√∂rbe√∂lelje)
            const arcSize = state.wristWidth * 2.2;
            dashedArc.style.width = arcSize + 'px';
            dashedArc.style.height = arcSize + 'px';
            dashedArc.style.marginLeft = -(arcSize/2) + 'px';
            dashedArc.style.marginTop = -(arcSize/2) + 'px';
            dashedArc.style.opacity = state.arcOpacity;
            
            // A k√∂r forgat√°sa - CSAK Y √©s Z, X fix d≈ël√©s
            dashedArc.style.transform = `
                rotateX(${CONFIG.circleTiltX}deg)
                rotateY(${state.rotY}deg)
                rotateZ(${state.rotZ}deg)
            `;

            requestAnimationFrame(animate);
        }

        initCamera();
        setMode('bracelet');
        animate();
    </script>
</body>
</html>
